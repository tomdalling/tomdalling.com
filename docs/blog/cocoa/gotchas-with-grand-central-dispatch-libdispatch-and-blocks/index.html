<!DOCTYPE html>
<html lang="en">
  <head>

    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Gotchas With Grand Central Dispatch (libdispatch) And Blocks — Tom Dalling</title>
    <link rel="stylesheet" href="/style.css">
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet">
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
  <link rel="canonical" href="/blog/cocoa/gotchas-with-grand-central-dispatch-libdispatch-and-blocks/">
</head>

  <body>

    <div class="container">

      <div class="row">
        <div class="col-md-12">
          <nav class="navbar navbar-default" role="navigation">
            <div class="container-fluid">
              <div class="navbar-header">
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                  <span class="sr-only">Toggle navigation</span>
                  <span class="icon-bar"></span>
                  <span class="icon-bar"></span>
                  <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand" href="/">Tom Dalling</a>
              </div>

              <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
                <ul class="nav navbar-nav">
                  <li><a href="/">Home</a></li>
                  <li><a href="/blog/">Blog</a></li>
                </ul>
              </div>
            </div>
          </nav>
        </div>
      </div>

      <div class="row">

        <main class="col-md-8"><article class="post post-single">

  <header>
    <h1><a href="/blog/cocoa/gotchas-with-grand-central-dispatch-libdispatch-and-blocks/">Gotchas With Grand Central Dispatch (libdispatch) And Blocks</a></h1>
    <small class="meta">
      <span class="post-date">02 Mar, 2012</span>
      —
      Category: <a class="category" href="/blog/category/cocoa/">Cocoa</a>
    </small>
    
  </header>

  <div class="post-content">
<p><a href="http://en.wikipedia.org/wiki/Grand_Central_Dispatch" title="Grand Central Dispatch">GCD</a> is a nice replacement for the old
<code><a href="https://developer.apple.com/library/mac/documentation/Cocoa/Reference/Foundation/Classes/nsobject_Class/Reference/Reference.html#//apple_ref/occ/instm/NSObject/performSelectorInBackground:withObject:">performSelectorInBackground:withObject:</a></code> and
<code><a href="https://developer.apple.com/library/mac/documentation/Cocoa/Reference/Foundation/Classes/nsobject_Class/Reference/Reference.html#//apple_ref/occ/instm/NSObject/performSelectorOnMainThread:withObject:waitUntilDone:">performSelectorOnMainThread:withObject:waitUntilDone:</a></code> methods
and <a href="https://developer.apple.com/library/mac/#documentation/Cocoa/Reference/NSOperation_class/Reference/Reference.html">NSOperation</a>. It's also a nice supplement to <a href="https://developer.apple.com/library/mac/#documentation/Cocoa/Reference/Foundation/Classes/nsthread_Class/Reference/Reference.html">NSThread</a>.</p>

<p>However, I think it was over-hyped a little bit by Apple when it was first
released. You probably have all these random deadlocks and race conditions and
stuff whenever you use multiple threads, but GCD is <em>soooooo good</em> that you
don't have to worry about that anymore. Just use these magic blocks.</p>

<p>The problem is that concurrent programming is notoriously hard to get right.
Maybe GCD helps to make it easier, but It doesn't solve all of your problems.
In fact, GCD and blocks introduce some problems of their own. This article will
focus on some of those problems.</p>

<!--more-->

<h2>Blocks Are Stack Allocated</h2>

<p>Invariably, when you start using blocks you will find out the hard way that
blocks are allocated on the stack. It is natural to think along the lines of:
<em>"Blocks are objects in Objective-C, right? I'll just retain it and use it
later."</em> But when you go to use the block, you get weird crashes that are hard
to debug.</p>

<p>Stack allocated memory is deallocated when it goes out of scope. If you make a
block inside of a method then it is deallocated when the method finishes,
regardless of how many times it is retained. You need to copy the block if you
want it to survive going out of scope, because copied blocks are heap
allocated.</p>

<h2>Dispatch Barriers</h2>

<p>GCD has the ability to dispatch "barriers". When a block is dispatched as a
barrier, it will not run until all blocks before it in the queue have finished.
Then, once it is guaranteed to be the only thing running in the dispatch queue,
the block is run until completion. Once the barrier block has finished, the
queue resumes executing blocks as it normally would.</p>

<p>Barriers have their uses, but they also introduce a problem. Let's say you have
a block running on the default priority global queue and it needs to pop back
onto the main thread, so it does a <code>dispatch_sync</code> onto the main queue.
Meanwhile, over on the main thread, someone decides to do a
<code>dispatch_barrier_sync</code> onto the default priority global queue. Now you have a
deadlock. The main thread is waiting on the barrier, the barrier won't execute
because it's waiting on the block in front, and the block in front won't
execute because it's waiting on the main thread.</p>

<p><strong>Any time you <code>dispatch_sync</code> to the main thread from one of the global queues
– which is extremely common – you risk deadlock.</strong></p>

<p>You're probably thinking that dispatching a barrier from the main thread to a
shared global queue is a horrible idea, and that nobody should be doing it in
the first place. I totally agree with you. Unfortunately, this is exactly what
Apple does. I have come across this exact bug when clicking a toolbar item.
Deep inside Apple frameworks, code which I assume is responsible for darkening
the image of the toolbar item calls <code>dispatch_barrier_sync</code>. I wish I could
find a screenshot I took of the stack trace, but alas I can not. I assume this
is a bug, and I expect it will be fixed eventually, but you can't rely on third
party code playing nicely with the global queues.</p>

<p>Remember how everyone told you globals were bad? This is exactly why.</p>

<p>The solution is to make your own dispatch queue instead of using the global
ones. Third party code can't dispatch a barrier onto your queue if they don't
have a pointer to it.</p>

<h2>512 Thread Limit</h2>

<p>GCD tries to hide the use of threads with abstraction, but the <a href="http://en.wikipedia.org/wiki/Leaky_abstraction" title="Leaky abstraction">abstraction is
leaky</a>. The threads are still there, lurking just below the surface. If
you're not careful, you may find that you hit the 512 thread limit
accidentally, and then GCD will start going weird on you.</p>

<p>Every time a queue wants to run a block, GCD tries to reuse a thread that has
finished running a block and is now doing nothing. However, if all the threads
are busy running their blocks then GCD will create a new thread for you.</p>

<p>Let's say you are about to add more than 512 blocks to queues. If the blocks
finish fairly quickly then there is no problem, because the threads will be
reused. But what if, instead of finishing quickly, they all start waiting on a
lock? Now you have a problem. Every time you add a new block it looks for
threads to reuse, but all the threads are busy waiting on a lock, so GCD makes
a new thread for you. Every block ends up with its own thread, and now you've
accidentally hit the thread limit.</p>

<p>There isn't a whole lot of documentation about this, but if you click "Sample
Process" from Activity Monitor, it will tell you when you have hit the 512
thread limit. If your app locks up and you can't work out why, it might be
worth checking.</p>

<p>To solve this one, you might want to add your blocks to serial queues. The
serial queues basically have a single thread, and execute the blocks one at a
time. You'll be fine as long as you don't have 512 serial queues all running at
once.</p>

</div>

  <footer>
    <div class="alert alert-info subscribe-bait">
      <p><strong>Enjoy this post?</strong></p>
      <a href="/feed/" class="btn btn-success">
        Subscribe via RSS
      </a>
      <a href="https://twitter.com/tom_dalling" class="twitter-follow-button" data-show-count="false" data-size="large">Follow @tom_dalling</a>
      <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>
    </div>

    <h2>Comments</h2>
    <div id="disqus_thread"></div>
    <script type="text/javascript" id="disqus_script">
      var disqus_shortname = "tomdalling";
      var disqus_identifier = "563 http://tomdalling.com/blog/?p=563";
      var disqus_title = "Gotchas With Grand Central Dispatch (libdispatch) And Blocks";
      var disqus_url = "https://www.tomdalling.com/blog/cocoa/gotchas-with-grand-central-dispatch-libdispatch-and-blocks/";

      (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
      })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments.</a>
</noscript>
  </footer>
</article>
</main>

        <div class="col-md-4 sidebar">

          <div class="panel panel-default">
            <div class="panel-heading">Subscribe</div>
            <ul class="list-group">
              <li class="list-group-item">
                <a href="/blog/feed/">
                  <i class="fa fa-rss"></i> RSS
                </a>
              </li>
              <li class="list-group-item">
                <a href="https://twitter.com/tom_dalling">
                  <i class="fa fa-twitter"></i> Twitter
                </a>
              </li>
            </ul>
          </div>

          <div class="panel panel-default">
            <div class="panel-heading">Recent Posts</div>
            <ul class="list-group recent-posts">
              
            <li class="list-group-item">
                <a href="/blog/ruby/pure-function-as-an-object-PFAAO-pattern/">The Pure Function As An Object (PFAAO) Ruby Pattern</a>
              </li>
<li class="list-group-item">
                <a href="/blog/software-design/fizzbuzz-in-too-much-detail/">FizzBuzz In Too Much Detail</a>
              </li>
<li class="list-group-item">
                <a href="/blog/ruby/fruity-bat-flappy-bird-clone-in-ruby/">Making Fruity Bat (a Flappy Bird clone) in Ruby</a>
              </li>
<li class="list-group-item">
                <a href="/blog/modern-opengl/08-even-more-lighting-directional-lights-spotlights-multiple-lights/">Modern OpenGL 08 – Even More Lighting: Directional Lights, Spotlights, &amp; Multiple Lights</a>
              </li>
<li class="list-group-item">
                <a href="/blog/modern-opengl/opengl-in-2014/">OpenGL in 2014</a>
              </li>
</ul>
          </div>

          <div class="panel panel-default">
            <div class="panel-heading">Blog Categories</div>
            <ul class="list-group categories">
              
            <li class="list-group-item">
                <a href="/blog/category/cocoa/" class="category">Cocoa</a>
                (<span class="post-count">5</span>
                <a class="feed" href="/blog/category/cocoa/feed/"><i class="fa fa-rss"></i></a>)
              </li>
<li class="list-group-item">
                <a href="/blog/category/coding-styleconventions/" class="category">Coding Style/Conventions</a>
                (<span class="post-count">3</span>
                <a class="feed" href="/blog/category/coding-styleconventions/feed/"><i class="fa fa-rss"></i></a>)
              </li>
<li class="list-group-item">
                <a href="/blog/category/coding-tips/" class="category">Coding Tips</a>
                (<span class="post-count">4</span>
                <a class="feed" href="/blog/category/coding-tips/feed/"><i class="fa fa-rss"></i></a>)
              </li>
<li class="list-group-item">
                <a href="/blog/category/random-stuff/" class="category">Miscellaneous</a>
                (<span class="post-count">1</span>
                <a class="feed" href="/blog/category/random-stuff/feed/"><i class="fa fa-rss"></i></a>)
              </li>
<li class="list-group-item">
                <a href="/blog/category/modern-opengl/" class="category">Modern OpenGL Series</a>
                (<span class="post-count">10</span>
                <a class="feed" href="/blog/category/modern-opengl/feed/"><i class="fa fa-rss"></i></a>)
              </li>
<li class="list-group-item">
                <a href="/blog/category/ruby/" class="category">Ruby</a>
                (<span class="post-count">2</span>
                <a class="feed" href="/blog/category/ruby/feed/"><i class="fa fa-rss"></i></a>)
              </li>
<li class="list-group-item">
                <a href="/blog/category/software-design/" class="category">Software Design</a>
                (<span class="post-count">9</span>
                <a class="feed" href="/blog/category/software-design/feed/"><i class="fa fa-rss"></i></a>)
              </li>
<li class="list-group-item">
                <a href="/blog/category/software-processes/" class="category">Software Processes</a>
                (<span class="post-count">1</span>
                <a class="feed" href="/blog/category/software-processes/feed/"><i class="fa fa-rss"></i></a>)
              </li>
<li class="list-group-item">
                <a href="/blog/category/web/" class="category">Web</a>
                (<span class="post-count">1</span>
                <a class="feed" href="/blog/category/web/feed/"><i class="fa fa-rss"></i></a>)
              </li>
</ul>
          </div>

          <div class="panel panel-default">
            <div class="panel-heading">Blog Archives</div>
            <ul class="list-group archives">
              
            <li class="list-group-item">
                <a href="/blog/2016/02/" class="month">February 2016</a>
                (<span class="post-count">1</span>)
              </li>
<li class="list-group-item">
                <a href="/blog/2015/04/" class="month">April 2015</a>
                (<span class="post-count">1</span>)
              </li>
<li class="list-group-item">
                <a href="/blog/2015/02/" class="month">February 2015</a>
                (<span class="post-count">1</span>)
              </li>
<li class="list-group-item">
                <a href="/blog/2014/11/" class="month">November 2014</a>
                (<span class="post-count">1</span>)
              </li>
<li class="list-group-item">
                <a href="/blog/2014/09/" class="month">September 2014</a>
                (<span class="post-count">1</span>)
              </li>
<li class="list-group-item">
                <a href="/blog/2014/02/" class="month">February 2014</a>
                (<span class="post-count">1</span>)
              </li>
<li class="list-group-item">
                <a href="/blog/2013/04/" class="month">April 2013</a>
                (<span class="post-count">1</span>)
              </li>
<li class="list-group-item">
                <a href="/blog/2013/03/" class="month">March 2013</a>
                (<span class="post-count">1</span>)
              </li>
<li class="list-group-item">
                <a href="/blog/2013/02/" class="month">February 2013</a>
                (<span class="post-count">1</span>)
              </li>
<li class="list-group-item">
                <a href="/blog/2013/01/" class="month">January 2013</a>
                (<span class="post-count">2</span>)
              </li>
<li class="list-group-item">
                <a href="/blog/2012/12/" class="month">December 2012</a>
                (<span class="post-count">2</span>)
              </li>
<li class="list-group-item">
                <a href="/blog/2012/11/" class="month">November 2012</a>
                (<span class="post-count">2</span>)
              </li>
<li class="list-group-item">
                <a href="/blog/2012/07/" class="month">July 2012</a>
                (<span class="post-count">2</span>)
              </li>
<li class="list-group-item">
                <a href="/blog/2012/05/" class="month">May 2012</a>
                (<span class="post-count">2</span>)
              </li>
<li class="list-group-item">
                <a href="/blog/2012/03/" class="month">March 2012</a>
                (<span class="post-count">2</span>)
              </li>
<li class="list-group-item">
                <a href="/blog/2011/12/" class="month">December 2011</a>
                (<span class="post-count">1</span>)
              </li>
<li class="list-group-item">
                <a href="/blog/2010/12/" class="month">December 2010</a>
                (<span class="post-count">1</span>)
              </li>
<li class="list-group-item">
                <a href="/blog/2010/11/" class="month">November 2010</a>
                (<span class="post-count">1</span>)
              </li>
<li class="list-group-item">
                <a href="/blog/2010/05/" class="month">May 2010</a>
                (<span class="post-count">1</span>)
              </li>
<li class="list-group-item">
                <a href="/blog/2010/04/" class="month">April 2010</a>
                (<span class="post-count">1</span>)
              </li>
<li class="list-group-item">
                <a href="/blog/2010/02/" class="month">February 2010</a>
                (<span class="post-count">1</span>)
              </li>
<li class="list-group-item">
                <a href="/blog/2009/12/" class="month">December 2009</a>
                (<span class="post-count">1</span>)
              </li>
<li class="list-group-item">
                <a href="/blog/2009/11/" class="month">November 2009</a>
                (<span class="post-count">3</span>)
              </li>
<li class="list-group-item">
                <a href="/blog/2009/10/" class="month">October 2009</a>
                (<span class="post-count">2</span>)
              </li>
<li class="list-group-item">
                <a href="/blog/2009/07/" class="month">July 2009</a>
                (<span class="post-count">1</span>)
              </li>
<li class="list-group-item">
                <a href="/blog/2009/06/" class="month">June 2009</a>
                (<span class="post-count">1</span>)
              </li>
<li class="list-group-item">
                <a href="/blog/2009/05/" class="month">May 2009</a>
                (<span class="post-count">1</span>)
              </li>
</ul>
          </div>

        </div>
      </div>

      <footer class="page-footer">
        <p>© 2009 – <span class="current-year">2020</span> Tom Dalling</p>

        <p class="social">
          <a href="https://twitter.com/tom_dalling">
            <i class="fa fa-lg fa-twitter"></i>
          </a>
          <a href="https://github.com/tomdalling">
            <i class="fa fa-lg fa-github"></i>
          </a>
          <a href="https://stackoverflow.com/users/108105/tom-dalling">
            <i class="fa fa-lg fa-stack-overflow"></i>
          </a>
          <a href="mailto:tom%20at%20tomdalling%20com">
            <i class="fa fa-lg fa-envelope"></i>
          </a>
        </p>
      </footer>

      <script src="/bundles/all.js"></script>
      <script type="text/x-mathjax-config">
        MathJax.Hub.Config({
          tex2jax: {
            inlineMath: [['$$','$$']],
            displayMath: [['[blockmath]', '[/blockmath]']]
          }
        });
      </script>
      <script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    </div>
</body>
</html>
