<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>The Pure Function As An Object (PFAAO) Ruby Pattern — Tom Dalling</title>
    <link rel="stylesheet" href="/style.css">
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet">

    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link href="https://fonts.googleapis.com/css2?family=Merriweather+Sans:wght@700&amp;family=Merriweather:ital,wght@0,400;0,700;1,400;1,700&amp;family=Montserrat:ital,wght@0,400;0,700;1,400&amp;display=swap" rel="stylesheet">

    <meta name="twitter:site" content="@tom_dalling">
    <meta name="twitter:creator" content="@tom_dalling">
    <link rel="alternate" type="application/rss+xml" title="Tom Dalling" href="https://www.tomdalling.com/blog/feed/">
  <link rel="canonical" href="https://www.tomdalling.com/blog/ruby/pure-function-as-an-object-PFAAO-pattern/">
<meta property="og:title" content="The Pure Function As An Object (PFAAO) Ruby Pattern">
<meta property="og:url" content="https://www.tomdalling.com/blog/ruby/pure-function-as-an-object-PFAAO-pattern/">
<meta property="og:image" content="https://www.tomdalling.com/images/posts/ruby.jpg">
<meta name="twitter:card" content="summary_large_image">
</head>

  <body>

    <header class="tw-mb-6 tw-py-2 tw-bg-gray-100 tw-border-b tw-border-gray-200 tw-font-title">
      <nav class="tw-container tw-mx-auto max-w-screen-xl tw-space-x-8 tw-px-4">
        <a href="/" class="tw-text-xl tw-text-black">Tom Dalling</a>
        <a href="/blog/" class="tw-text-black">Blog</a>
      </nav>
    </header>

    <div class="tw-container tw-mx-auto tw-flex tw-flex-col lg:tw-flex-row">

      <main class="tw-flex-1 tw-min-w-0 tw-px-4"><article class="post post-single">

  <header>
    <h1><a href="/blog/ruby/pure-function-as-an-object-PFAAO-pattern/">The Pure Function As An Object (PFAAO) Ruby Pattern</a></h1>
    <small class="meta">
      <span class="post-date">12 Feb, 2016</span>
      
      —
      Category: <a class="category" href="/blog/category/ruby/">Ruby</a>
      —
      Suggest changes <a class="post-github" href="https://github.com/tomdalling/tomdalling.com/tree/main/input/posts/2016-02-12_pure-function-as-an-object-PFAAO-pattern.markdown">on GitHub</a>
    </small>
    <div class="main-image">
      <img src="/images/posts/ruby.jpg" class="img-responsive">
      <span class="credit">Image courtesy of <a class="artist" href="http://www.irocks.com/">Rob Lavinsky, iRocks.com</a>.</span>
    </div>
  </header>

  <div class="post-content body-text">
<p>In this article, I want to demonstrate a nice way to write functional-style code in Ruby.
It is a way to write non-trivial pure functions, without a bunch of weird non-idiomatic code.
Also, the acronym is PFAAO, which I think sounds pretty cool.</p>

<!--more-->

<h2>Pure Functions</h2>

<p>Pure functions are functions that have no side-effects, and whose return values are only determined by their arguments.
Given the same arguments, a pure function will always return the same value.
It does nothing other than generate a return value – it doesn’t affect anything, anywhere else in the program.</p>

<p>Pure functions are the core concept of functional programming (FP).
I’m going to gloss over the benefits of FP, because there are plenty of other articles about that.
Let’s just say that pure functions are good, and you should be writing them wherever possible.</p>

<h2>The Example: A JSON To XML Converter</h2>

<p>To demonstrate this pattern, I’m going to write a program that converts a JSON document to XML.
The whole example project is available on GitHub, here: <a href="https://github.com/tomdalling/pure-function-as-an-object">https://github.com/tomdalling/pure-function-as-an-object</a></p>

<p>The input looks like this:</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w"> </span><span class="nl">"city"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"AGAWAM"</span><span class="p">,</span><span class="w"> </span><span class="nl">"loc"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="mf">-72.622739</span><span class="p">,</span><span class="w"> </span><span class="mf">42.070206</span><span class="w"> </span><span class="p">],</span><span class="w"> </span><span class="nl">"pop"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="mi">15338</span><span class="p">,</span><span class="w"> </span><span class="nl">"state"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"MA"</span><span class="p">,</span><span class="w"> </span><span class="nl">"_id"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"01001"</span><span class="w"> </span><span class="p">}</span><span class="w">
</span><span class="p">{</span><span class="w"> </span><span class="nl">"city"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"CUSHMAN"</span><span class="p">,</span><span class="w"> </span><span class="nl">"loc"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="mf">-72.51564999999999</span><span class="p">,</span><span class="w"> </span><span class="mf">42.377017</span><span class="w"> </span><span class="p">],</span><span class="w"> </span><span class="nl">"pop"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="mi">36963</span><span class="p">,</span><span class="w"> </span><span class="nl">"state"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"MA"</span><span class="p">,</span><span class="w"> </span><span class="nl">"_id"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"01002"</span><span class="w"> </span><span class="p">}</span><span class="w">
</span><span class="p">{</span><span class="w"> </span><span class="nl">"city"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"BARRE"</span><span class="p">,</span><span class="w"> </span><span class="nl">"loc"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="mf">-72.10835400000001</span><span class="p">,</span><span class="w"> </span><span class="mf">42.409698</span><span class="w"> </span><span class="p">],</span><span class="w"> </span><span class="nl">"pop"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="mi">4546</span><span class="p">,</span><span class="w"> </span><span class="nl">"state"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"MA"</span><span class="p">,</span><span class="w"> </span><span class="nl">"_id"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"01005"</span><span class="w"> </span><span class="p">}</span><span class="w">
</span><span class="p">{</span><span class="w"> </span><span class="nl">"city"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"BELCHERTOWN"</span><span class="p">,</span><span class="w"> </span><span class="nl">"loc"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="mf">-72.41095300000001</span><span class="p">,</span><span class="w"> </span><span class="mf">42.275103</span><span class="w"> </span><span class="p">],</span><span class="w"> </span><span class="nl">"pop"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="mi">10579</span><span class="p">,</span><span class="w"> </span><span class="nl">"state"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"MA"</span><span class="p">,</span><span class="w"> </span><span class="nl">"_id"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"01007"</span><span class="w"> </span><span class="p">}</span><span class="w">
</span><span class="p">{</span><span class="w"> </span><span class="nl">"city"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"BLANDFORD"</span><span class="p">,</span><span class="w"> </span><span class="nl">"loc"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="mf">-72.936114</span><span class="p">,</span><span class="w"> </span><span class="mf">42.182949</span><span class="w"> </span><span class="p">],</span><span class="w"> </span><span class="nl">"pop"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="mi">1240</span><span class="p">,</span><span class="w"> </span><span class="nl">"state"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"MA"</span><span class="p">,</span><span class="w"> </span><span class="nl">"_id"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"01008"</span><span class="w"> </span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>And the output looks like this:</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?xml version="1.0"?&gt;</span>
<span class="nt">&lt;cities</span> <span class="na">count=</span><span class="s">"5"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;city</span> <span class="na">id=</span><span class="s">"01001"</span> <span class="na">name=</span><span class="s">"AGAWAM"</span> <span class="na">state=</span><span class="s">"MA"</span> <span class="na">location=</span><span class="s">"-72.622739,42.070206"</span> <span class="na">population=</span><span class="s">"15338"</span><span class="nt">/&gt;</span>
  <span class="nt">&lt;city</span> <span class="na">id=</span><span class="s">"01002"</span> <span class="na">name=</span><span class="s">"CUSHMAN"</span> <span class="na">state=</span><span class="s">"MA"</span> <span class="na">location=</span><span class="s">"-72.51565,42.377017"</span> <span class="na">population=</span><span class="s">"36963"</span><span class="nt">/&gt;</span>
  <span class="nt">&lt;city</span> <span class="na">id=</span><span class="s">"01005"</span> <span class="na">name=</span><span class="s">"BARRE"</span> <span class="na">state=</span><span class="s">"MA"</span> <span class="na">location=</span><span class="s">"-72.108354,42.409698"</span> <span class="na">population=</span><span class="s">"4546"</span><span class="nt">/&gt;</span>
  <span class="nt">&lt;city</span> <span class="na">id=</span><span class="s">"01007"</span> <span class="na">name=</span><span class="s">"BELCHERTOWN"</span> <span class="na">state=</span><span class="s">"MA"</span> <span class="na">location=</span><span class="s">"-72.410953,42.275103"</span> <span class="na">population=</span><span class="s">"10579"</span><span class="nt">/&gt;</span>
  <span class="nt">&lt;city</span> <span class="na">id=</span><span class="s">"01008"</span> <span class="na">name=</span><span class="s">"BLANDFORD"</span> <span class="na">state=</span><span class="s">"MA"</span> <span class="na">location=</span><span class="s">"-72.936114,42.182949"</span> <span class="na">population=</span><span class="s">"1240"</span><span class="nt">/&gt;</span>
<span class="nt">&lt;/cities&gt;</span>
</code></pre></div></div>

<p>We will only be using the Ruby 2.3.0 standard library, and the <a href="https://github.com/ohler55/ox">Ox gem</a> for writing the XML.</p>

<p>Let’s get started!</p>

<h2>Designing The API</h2>

<p>After gathering the requirements, the next step is to ask: how much of this can be implemented with pure functions?</p>

<p>As it turns out, pretty much the entire thing could be a pure function.
Reading the input is non-pure, and writing the output is also non-pure, but the entire conversion from JSON to XML <em>is</em> pure.
The same input JSON always produces the same output XML.</p>

<p>The API for this converter could be used like this:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">input</span> <span class="o">=</span> <span class="no">File</span><span class="p">.</span><span class="nf">read</span><span class="p">(</span><span class="s1">'input.json'</span><span class="p">)</span>
<span class="n">output</span> <span class="o">=</span> <span class="no">JSON2XML</span><span class="p">.</span><span class="nf">convert</span><span class="p">(</span><span class="n">input</span><span class="p">)</span>
<span class="no">File</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="s1">'output.xml'</span><span class="p">,</span> <span class="n">output</span><span class="p">)</span>
</code></pre></div></div>

<p>This example code could easily be written as a test.
Just use some dummy input, and assert that <code>output</code> is correct.</p>

<p>Because the <code>File.read</code> and <code>File.write</code> calls are non-pure, I have purposely kept them separate from the conversion code.
That allows the conversion step to be implemented as a pure function – it just takes a string and returns a string.</p>

<p>This API looks pretty good to me, assuming that the input data isn’t too big.
If the input data set was huge, we wouldn’t be able to load the whole thing into memory, so we would need so write some sort of streaming API.
But, for the sake of demonstration, let’s assume that we’ve investigated this possibility and decided that it’s very unlikely that the input will ever be more than a few megabytes.</p>

<div class="alert alert-info">
  This is an example of the
  <a href="http://mollyrocket.com/casey/stream_0029.html">"write the usage code first" school of API design</a>,
  as advocated by Casey Muratori.
  For more API design advice from Casey, I recommend watching his talk:
  <a href="http://mollyrocket.com/casey/stream_0028.html">Designing and Evaluating Reusable Components</a>.
</div>

<h2>The Motivation</h2>

<p>The public API consists of a single method, which will be the pure function.
Let’s start with that:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">require</span> <span class="s1">'json'</span>
<span class="nb">require</span> <span class="s1">'ox'</span>

<span class="k">module</span> <span class="nn">JSON2XML</span>
  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">convert</span><span class="p">(</span><span class="n">input_json</span><span class="p">)</span>
    <span class="c1"># TODO: implementation goes here</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>We could easily implement all the functionality by writing a bunch of pure methods on the <code>JSON2XML</code> module, without defining any new classes.
It would work, but I personally don’t think that this is how Ruby is designed to be used.
It’s not what most people would consider to be idiomatic Ruby.
We would be fighting the language – going against the grain.
That’s not fun.</p>

<p>To use Ruby the way it is designed to be used, we will need to define a class here.
However, the class is unnecessary.
It’s an implementation detail.
The public API is just a single pure function, so nobody should ever need to instantiate an object of the class we’re about to create.</p>

<p>This is the motivation behind the pattern: we want the public API to be a simple pure function, but we want to implement that function with a private class.</p>

<h2>The Pattern</h2>

<p>Without further ado, here is the pattern:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">require</span> <span class="s1">'json'</span>
<span class="nb">require</span> <span class="s1">'ox'</span>

<span class="k">class</span> <span class="nc">JSON2XML</span>
  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">convert</span><span class="p">(</span><span class="n">input_json</span><span class="p">)</span>
    <span class="n">new</span><span class="p">(</span><span class="n">input_json</span><span class="p">).</span><span class="nf">send</span><span class="p">(</span><span class="ss">:xml</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="kp">private</span>
    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">input_json</span><span class="p">)</span>
      <span class="vi">@input_json</span> <span class="o">=</span> <span class="n">input_json</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">xml</span>
      <span class="c1"># TODO: implementation goes here</span>
    <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>Instead of a module, <code>JSON2XML</code> is now a class.
Everything below the <code>convert</code> method is marked as private, signalling to other developers that <code>convert</code> is the only thing they should be calling, and everything else is an implementation detail.
The <code>xml</code> method can’t be called directly because it is private, so we use <code>send(:xml)</code> to get around that.</p>

<p>The <code>convert</code> class method:</p>

<ol>
  <li>creates an object of its own class,</li>
  <li>passing its argument into the initializer,</li>
  <li>and calls a single method on the object, to generate the return value.</li>
</ol>

<p>That’s the overview of how the pattern works.</p>

<h2>Implementation Advantages</h2>

<p>Now let’s finish off the implementation of the JSON to XML converter, to demonstrate some advantages of using this pattern.</p>

<p>The <code>xml</code> method is empty at the moment.
It’s supposed to return the output XML as a string, as required by the <code>convert</code> class method.
How do you generate XML?
One approach is to take some sort of XML “document” object, and serialize it.
Let’s do that:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">xml</span>
  <span class="no">Ox</span><span class="p">.</span><span class="nf">dump</span><span class="p">(</span><span class="n">document</span><span class="p">,</span> <span class="ss">with_xml: </span><span class="kp">true</span><span class="p">)</span>
<span class="k">end</span>
</code></pre></div></div>

<p>“But wait!”
I hear you say.
“There is no <code>document</code> object. It doesn’t exist.”
Let’s create it, then.</p>

<p>How do you make a document object?
Since we’re using the Ox gem, we need to instantiate an <code>Ox::Document</code> and fill it with all the output.
XML documents are only supposed to have a single root node in them, so all the content will have to be inside that.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">document</span>
  <span class="no">Ox</span><span class="o">::</span><span class="no">Document</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="ss">version: </span><span class="s1">'1.0'</span><span class="p">).</span><span class="nf">tap</span> <span class="k">do</span> <span class="o">|</span><span class="n">doc</span><span class="o">|</span>
    <span class="n">doc</span> <span class="o">&lt;&lt;</span> <span class="n">root_node</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>“But wait!”
I hear you say, again.
“Where did this <code>root_node</code> come from? That’s not defined anywhere.”
Let’s create it, then.</p>

<p>How do you make the root node?
In Ox, you instantiate a <code>Ox::Element</code> object.
We have to fill the root node with all the output data, so each city will have its own node inside the root node.
Also, the root node has a “count” attribute on it, for reasons that I will explain later.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">root_node</span>
  <span class="no">Ox</span><span class="o">::</span><span class="no">Element</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="s1">'cities'</span><span class="p">).</span><span class="nf">tap</span> <span class="k">do</span> <span class="o">|</span><span class="n">root</span><span class="o">|</span>
    <span class="n">root</span><span class="p">[</span><span class="ss">:count</span><span class="p">]</span> <span class="o">=</span> <span class="n">city_nodes</span><span class="p">.</span><span class="nf">size</span>
    <span class="n">city_nodes</span><span class="p">.</span><span class="nf">each</span> <span class="p">{</span> <span class="o">|</span><span class="n">city</span><span class="o">|</span> <span class="n">root</span> <span class="o">&lt;&lt;</span> <span class="n">city</span> <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>“But wait!”
I hear you say, for a third time.
“<code>city_nodes</code> doesn’t exist either!”
Let’s create it.
I’m sure you’re getting the gist of what’s happening here.</p>

<p>Each city node is also an <code>Ox::Element</code> object.
We can create a city node from each line of the JSON input.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">city_nodes</span>
  <span class="n">input_json</span><span class="p">.</span><span class="nf">each_line</span><span class="p">.</span><span class="nf">map</span> <span class="p">{</span> <span class="o">|</span><span class="n">line</span><span class="o">|</span> <span class="n">parse_city_node</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="p">}</span>
<span class="k">end</span>
</code></pre></div></div>

<p>The <code>input_json</code> method is missing.
That is the string value that was passed into the initializer.
We can implement that with a simple <code>attr_reader :input_json</code>.</p>

<p>The <code>parse_city_node</code> method needs to be implemented, too.
Here it is:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">parse_city_node</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
  <span class="no">Ox</span><span class="o">::</span><span class="no">Element</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="s1">'city'</span><span class="p">).</span><span class="nf">tap</span> <span class="k">do</span> <span class="o">|</span><span class="n">city</span><span class="o">|</span>
    <span class="n">attrs</span> <span class="o">=</span> <span class="no">JSON</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

    <span class="n">city</span><span class="p">[</span><span class="ss">:id</span><span class="p">]</span> <span class="o">=</span> <span class="n">attrs</span><span class="p">.</span><span class="nf">fetch</span><span class="p">(</span><span class="s1">'_id'</span><span class="p">)</span>
    <span class="n">city</span><span class="p">[</span><span class="ss">:name</span><span class="p">]</span> <span class="o">=</span> <span class="n">attrs</span><span class="p">.</span><span class="nf">fetch</span><span class="p">(</span><span class="s1">'city'</span><span class="p">)</span>
    <span class="n">city</span><span class="p">[</span><span class="ss">:state</span><span class="p">]</span> <span class="o">=</span> <span class="n">attrs</span><span class="p">.</span><span class="nf">fetch</span><span class="p">(</span><span class="s1">'state'</span><span class="p">)</span>
    <span class="n">city</span><span class="p">[</span><span class="ss">:location</span><span class="p">]</span> <span class="o">=</span> <span class="n">attrs</span><span class="p">.</span><span class="nf">fetch</span><span class="p">(</span><span class="s1">'loc'</span><span class="p">).</span><span class="nf">join</span><span class="p">(</span><span class="s1">','</span><span class="p">)</span>
    <span class="n">city</span><span class="p">[</span><span class="ss">:population</span><span class="p">]</span> <span class="o">=</span> <span class="n">attrs</span><span class="p">.</span><span class="nf">fetch</span><span class="p">(</span><span class="s1">'pop'</span><span class="p">).</span><span class="nf">to_s</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>“But wait!”
I don’t hear you say, because the implementation is now complete.
Here is the whole class:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">JSON2XML</span>
  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">convert</span><span class="p">(</span><span class="n">input_json</span><span class="p">)</span>
    <span class="n">new</span><span class="p">(</span><span class="n">input_json</span><span class="p">).</span><span class="nf">send</span><span class="p">(</span><span class="ss">:xml</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="kp">private</span>
    <span class="nb">attr_reader</span> <span class="ss">:input_json</span>

    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">input_json</span><span class="p">)</span>
      <span class="vi">@input_json</span> <span class="o">=</span> <span class="n">input_json</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">xml</span>
      <span class="no">Ox</span><span class="p">.</span><span class="nf">dump</span><span class="p">(</span><span class="n">document</span><span class="p">,</span> <span class="ss">with_xml: </span><span class="kp">true</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">document</span>
      <span class="no">Ox</span><span class="o">::</span><span class="no">Document</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="ss">version: </span><span class="s1">'1.0'</span><span class="p">).</span><span class="nf">tap</span> <span class="k">do</span> <span class="o">|</span><span class="n">doc</span><span class="o">|</span>
        <span class="n">doc</span> <span class="o">&lt;&lt;</span> <span class="n">root_node</span>
      <span class="k">end</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">root_node</span>
      <span class="no">Ox</span><span class="o">::</span><span class="no">Element</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="s1">'cities'</span><span class="p">).</span><span class="nf">tap</span> <span class="k">do</span> <span class="o">|</span><span class="n">root</span><span class="o">|</span>
        <span class="n">root</span><span class="p">[</span><span class="ss">:count</span><span class="p">]</span> <span class="o">=</span> <span class="n">city_nodes</span><span class="p">.</span><span class="nf">size</span>
        <span class="n">city_nodes</span><span class="p">.</span><span class="nf">each</span> <span class="p">{</span> <span class="o">|</span><span class="n">city</span><span class="o">|</span> <span class="n">root</span> <span class="o">&lt;&lt;</span> <span class="n">city</span> <span class="p">}</span>
      <span class="k">end</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">city_nodes</span>
      <span class="n">input_json</span><span class="p">.</span><span class="nf">each_line</span><span class="p">.</span><span class="nf">map</span> <span class="p">{</span> <span class="o">|</span><span class="n">line</span><span class="o">|</span> <span class="n">parse_city_node</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="p">}</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">parse_city_node</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
      <span class="no">Ox</span><span class="o">::</span><span class="no">Element</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="s1">'city'</span><span class="p">).</span><span class="nf">tap</span> <span class="k">do</span> <span class="o">|</span><span class="n">city</span><span class="o">|</span>
        <span class="n">attrs</span> <span class="o">=</span> <span class="no">JSON</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

        <span class="n">city</span><span class="p">[</span><span class="ss">:id</span><span class="p">]</span> <span class="o">=</span> <span class="n">attrs</span><span class="p">.</span><span class="nf">fetch</span><span class="p">(</span><span class="s1">'_id'</span><span class="p">)</span>
        <span class="n">city</span><span class="p">[</span><span class="ss">:name</span><span class="p">]</span> <span class="o">=</span> <span class="n">attrs</span><span class="p">.</span><span class="nf">fetch</span><span class="p">(</span><span class="s1">'city'</span><span class="p">)</span>
        <span class="n">city</span><span class="p">[</span><span class="ss">:state</span><span class="p">]</span> <span class="o">=</span> <span class="n">attrs</span><span class="p">.</span><span class="nf">fetch</span><span class="p">(</span><span class="s1">'state'</span><span class="p">)</span>
        <span class="n">city</span><span class="p">[</span><span class="ss">:location</span><span class="p">]</span> <span class="o">=</span> <span class="n">attrs</span><span class="p">.</span><span class="nf">fetch</span><span class="p">(</span><span class="s1">'loc'</span><span class="p">).</span><span class="nf">join</span><span class="p">(</span><span class="s1">','</span><span class="p">)</span>
        <span class="n">city</span><span class="p">[</span><span class="ss">:population</span><span class="p">]</span> <span class="o">=</span> <span class="n">attrs</span><span class="p">.</span><span class="nf">fetch</span><span class="p">(</span><span class="s1">'pop'</span><span class="p">).</span><span class="nf">to_s</span>
      <span class="k">end</span>
    <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>What I’ve just demonstrated is a top-down decomposition of the entire implementation.
You start with the desired output – in this case, an XML string – and work backwards.
You write the code that you wish existed, and implement it later.
This is a nice way to break down complicated algorithms into smaller, and smaller pieces.</p>

<p>This is all made possible by Ruby’s syntax.
Ruby blurs the line between local variables and a method calls.
This allows us to write identifiers representing values that we wish we had, as if they already exist as local variables, and then implement them later as methods.
We’re working with grain of the language, and this is one of the benefits.</p>

<p>Notice how none of the methods have side effects.
Each method in the class is itself a pure function.
The <code>@input_json</code> instance variable is never changed – it’s essentially a constant.
Because of that, we would expect that every method would always have the same return value.
For example, if I call the <code>xml</code> method three times, I would get three identical strings.
To use FP terminology, all of the methods have <em>referential transparency</em>.</p>

<h2>Performance Optimisation</h2>

<p>Astute readers may have noticed a performance hiccup in the <code>root_node</code> method.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">root_node</span>
  <span class="no">Ox</span><span class="o">::</span><span class="no">Element</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="s1">'cities'</span><span class="p">).</span><span class="nf">tap</span> <span class="k">do</span> <span class="o">|</span><span class="n">root</span><span class="o">|</span>
    <span class="n">root</span><span class="p">[</span><span class="ss">:count</span><span class="p">]</span> <span class="o">=</span> <span class="n">city_nodes</span><span class="p">.</span><span class="nf">size</span>
    <span class="n">city_nodes</span><span class="p">.</span><span class="nf">each</span> <span class="p">{</span> <span class="o">|</span><span class="n">city</span><span class="o">|</span> <span class="n">root</span> <span class="o">&lt;&lt;</span> <span class="n">city</span> <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>I put the “count” attribute on the root node to demonstrate a common performance problem with this pattern.</p>

<p>The problem is that <code>city_nodes</code> is called two times.
That means we’re parsing the entire data set twice.
That is unnecessary, and roughly doubles the run time of the conversion.</p>

<p>Thankfully, due to all the methods being pure, we have a simple solution to this problem: memoization.
Memoization is the caching of return values from pure functions.</p>

<p>We’ve already seen that the <code>city_nodes</code> method always returns the same value.
That means we can cache the return value the first time the function is called.
On all subsequent calls, we can just return the cached value without running the rest of the function.</p>

<p>Cache invalidation can be a tricky problem, but not in this case.
When do we need to invalidate the cache?
Never!
It’s a pure function.
The return value literally never changes.
We can just forget about cache invalidation completely.</p>

<p>Here is the solution:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">city_nodes</span>
  <span class="vi">@city_nodes</span> <span class="o">||=</span>
    <span class="n">input_json</span><span class="p">.</span><span class="nf">each_line</span><span class="p">.</span><span class="nf">map</span> <span class="p">{</span> <span class="o">|</span><span class="n">line</span><span class="o">|</span> <span class="n">parse_city_node</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="p">}</span>
<span class="k">end</span>
</code></pre></div></div>

<p>The function implementation is exactly the same, except for the <code>@city_nodes ||=</code> line that has been added.
This trick isn’t specific to the PFAAO pattern, it’s just normal, idiomatic Ruby.</p>

<p>Now we can call <code>city_nodes</code> as many times as we like, from any other method, without having to worry about performance.
This is a cleaner solution than storing the return value in a local variable before using it.</p>

<h2>When To Use PFAAO</h2>

<p>This pattern is good for implementing complicated pure functions.
I’ve written a DOCX to HTML converter this way, quite happily.</p>

<p>If the implementation is simple, it’s not really worth defining a new class – just write a slightly larger function.
If you’re writing a pure function and it’s growing out of control, that is the time to consider using this pattern.</p>

<p>Where the implementation is mostly pure, but not completely, you can still use this pattern.
The implementation will be more complicated, but still have a small and simple public API.
Ruby isn’t Haskell.
We can use side effects, in a controlled fashion, wherever it makes sense.</p>

<p>If your implementation requires a lot of mutable state, PFAAO is probably a bad fit.</p>

<h2>Optional Extras</h2>

<ul>
  <li>
    <p><strong>Disallow instantiation of the class.</strong><br>
Unfortunately, making <code>initialize</code> private does not prevent instantiation of the class.
The fact that everything is private except the class method should indicate that the class isn’t meant to be instantiated.
If that’s not strict enough for you, you can make Ruby raise an error by adding this line of code to the class definition:</p>

    <div class="language-ruby highlighter-rouge">
<div class="highlight"><pre class="highlight"><code><span class="nb">private_class_method</span> <span class="ss">:new</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p><strong>Make it quack like a Proc.</strong><br>
Objects that act like functions, such as <code>Proc</code> objects, are invoked using the <code>call</code> method in idiomatic Ruby.
I named the class method <code>convert</code> in the example above, but if you changed that to <code>call</code> you could use the class as if it were a <code>Proc</code>.
In that case, I would change the class name to <code>XML2JSONConverter</code> to keep the word “convert” in there.</p>
  </li>
  <li>
    <p><strong>Make it convertable to a Proc.</strong><br>
Let’s say you’re using this PFAAO as a block fiarly often, like this:</p>

    <div class="language-ruby highlighter-rouge">
<div class="highlight"><pre class="highlight"><code><span class="n">documents</span><span class="p">.</span><span class="nf">map</span><span class="p">{</span> <span class="o">|</span><span class="n">d</span><span class="o">|</span> <span class="no">XML2JSON</span><span class="p">.</span><span class="nf">convert</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="p">}</span>
</code></pre></div>    </div>

    <p>It would be nicer to just pass the block argument using ampersand syntax like this:</p>

    <div class="language-ruby highlighter-rouge">
<div class="highlight"><pre class="highlight"><code><span class="n">documents</span><span class="p">.</span><span class="nf">map</span><span class="p">(</span><span class="o">&amp;</span><span class="no">XML2JSON</span><span class="p">)</span>
</code></pre></div>    </div>

    <p>To make this a reality, implement the <code>to_proc</code> method on the class, like this:</p>

    <div class="language-ruby highlighter-rouge">
<div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">to_proc</span>
  <span class="nb">method</span><span class="p">(</span><span class="ss">:convert</span><span class="p">).</span><span class="nf">to_proc</span>
<span class="k">end</span>
</code></pre></div>    </div>
  </li>
</ul>

<h2>Conclusion</h2>

<p>It is possible, and even preferable, to write Ruby in a functional style.
No monads or category theory required.
Complicated pure functions can be written in idiomatic Ruby.</p>

<p>Again, you can get the code for the article from GitHub:
<a href="https://github.com/tomdalling/pure-function-as-an-object">https://github.com/tomdalling/pure-function-as-an-object</a></p>

<p>We’ve also learnt that PFAAO is a cool acronym.
Say it out loud.
PFAAO. PFAAO.</p>

<p>PFAAO…</p>
</div>

  <footer>
    <div class="tw-rounded-3xl tw-bg-pink-100 tw-p-8 tw-my-16 tw-text-center tw-bg-opacity-50">
      <p class="tw-text-2xl tw-uppercase tw-text-pink-900 tw-font-black tw-mb-4">Enjoy this?</p>

      <p class="tw-flex tw-flex-col sm:tw-flex-row tw-justify-center tw-item-center sm:tw-items-baseline">
        <a href="/feed/" class="tw-flex-1 tw-bg-pink-500 tw-py-3 tw-px-4 tw-rounded-lg tw-text-pink-100 tw-ring-2 tw-ring-pink-300 hover:tw-text-white">Subscribe via RSS</a>
        <span class="tw-flex-none tw-px-8 tw-py-4 tw-text-pink-800">or</span>
        <a href="https://twitter.com/tom_dalling" class="tw-flex-1 tw-bg-pink-500 tw-py-3 tw-px-4 tw-rounded-lg tw-text-pink-100 tw-ring-2 tw-ring-pink-300 hover:tw-text-white">Follow on Twitter</a>
      </p>

      <p class="tw-text-center tw-mt-4 tw-mb-0 tw-text-pink-900">
        <em>Found a mistake?</em> Pull requests are welcome on
        <a href="https://github.com/tomdalling/tomdalling.com/whatever">GitHub</a>.
      </p>
</div>

    


    
      <h2>Comments</h2>
      <div id="disqus_thread"></div>
      <script type="text/javascript" id="disqus_script">
        var disqus_shortname = "tomdalling";
        var disqus_identifier = "com.tomdalling.blog.pure-function-as-an-object";
        var disqus_title = "The Pure Function As An Object (PFAAO) Ruby Pattern";
        var disqus_url = "https://www.tomdalling.com/blog/ruby/pure-function-as-an-object-PFAAO-pattern/";

        (function() {
          var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
          dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
          (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
      </script>
      <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments.</a>
</noscript>
    

  </footer>
</article>
</main>

      <aside class="tw-px-4 tw-text-center lg:tw-text-left lg:tw-w-1/3 tw-flex-none">

        <div class="tw-text-lg tw-font-title tw-mb-1">Subscribe</div>
        <ul class="tw-space-y-2">
          <li>
            <a href="/blog/feed/">
              <i class="fa fa-rss"></i> RSS
            </a>
          </li>
          <li>
            <a href="https://twitter.com/tom_dalling">
              <i class="fa fa-twitter"></i> Twitter
            </a>
          </li>
        </ul>

        <div class="tw-text-lg tw-font-title tw-mb-1 tw-mt-6">Recent Posts</div>
        <ul class="recent-posts tw-space-y-2">
          
        <li><a href="/blog/mentoring/write-detailed-rspec-example-descriptions/">Write Detailed RSpec Example Descriptions</a></li>
<li><a href="/blog/mentoring/start-with-high-level-tests/">Start With High-Level Tests</a></li>
<li><a href="/blog/testing/the-tip-of-the-inputberg/">The Tip Of The Inputberg</a></li>
<li><a href="/blog/software-processes/better-user-stories/">Better User Stories</a></li>
<li><a href="/blog/software-design/consistent-hammer-man/">Consistent Hammer Man</a></li>
</ul>

        <div class="tw-text-lg tw-font-title tw-mb-1 tw-mt-6">Categories</div>
        <ul class="categories tw-space-y-2">
          
        <li>
            <a href="/blog/cocoa/" class="category">Cocoa</a>
            (<span class="post-count">5</span>
            <a class="feed" href="/blog/cocoa/feed/"><i class="fa fa-rss"></i></a>)
          </li>
<li>
            <a href="/blog/coding-styleconventions/" class="category">Coding Style/Conventions</a>
            (<span class="post-count">3</span>
            <a class="feed" href="/blog/coding-styleconventions/feed/"><i class="fa fa-rss"></i></a>)
          </li>
<li>
            <a href="/blog/coding-tips/" class="category">Coding Tips</a>
            (<span class="post-count">4</span>
            <a class="feed" href="/blog/coding-tips/feed/"><i class="fa fa-rss"></i></a>)
          </li>
<li>
            <a href="/blog/mentoring/" class="category">Mentoring Notes</a>
            (<span class="post-count">2</span>
            <a class="feed" href="/blog/mentoring/feed/"><i class="fa fa-rss"></i></a>)
          </li>
<li>
            <a href="/blog/random-stuff/" class="category">Miscellaneous</a>
            (<span class="post-count">3</span>
            <a class="feed" href="/blog/random-stuff/feed/"><i class="fa fa-rss"></i></a>)
          </li>
<li>
            <a href="/blog/modern-opengl/" class="category">Modern OpenGL Series</a>
            (<span class="post-count">10</span>
            <a class="feed" href="/blog/modern-opengl/feed/"><i class="fa fa-rss"></i></a>)
          </li>
<li>
            <a href="/blog/ruby/" class="category">Ruby</a>
            (<span class="post-count">2</span>
            <a class="feed" href="/blog/ruby/feed/"><i class="fa fa-rss"></i></a>)
          </li>
<li>
            <a href="/blog/software-design/" class="category">Software Design</a>
            (<span class="post-count">11</span>
            <a class="feed" href="/blog/software-design/feed/"><i class="fa fa-rss"></i></a>)
          </li>
<li>
            <a href="/blog/software-processes/" class="category">Software Processes</a>
            (<span class="post-count">2</span>
            <a class="feed" href="/blog/software-processes/feed/"><i class="fa fa-rss"></i></a>)
          </li>
<li>
            <a href="/blog/testing/" class="category">Testing</a>
            (<span class="post-count">1</span>
            <a class="feed" href="/blog/testing/feed/"><i class="fa fa-rss"></i></a>)
          </li>
<li>
            <a href="/blog/web/" class="category">Web</a>
            (<span class="post-count">1</span>
            <a class="feed" href="/blog/web/feed/"><i class="fa fa-rss"></i></a>)
          </li>
</ul>

        <div class="tw-text-lg tw-font-title tw-mb-1 tw-mt-6">Archives</div>
        <ul class="archives tw-space-y-2">
          
        <li>
            <a href="/blog/2021/" class="year">2021</a>
            (<span class="post-count">3</span>)
          </li>
<li>
            <a href="/blog/2020/" class="year">2020</a>
            (<span class="post-count">5</span>)
          </li>
<li>
            <a href="/blog/2016/" class="year">2016</a>
            (<span class="post-count">1</span>)
          </li>
<li>
            <a href="/blog/2015/" class="year">2015</a>
            (<span class="post-count">2</span>)
          </li>
<li>
            <a href="/blog/2014/" class="year">2014</a>
            (<span class="post-count">3</span>)
          </li>
<li>
            <a href="/blog/2013/" class="year">2013</a>
            (<span class="post-count">5</span>)
          </li>
<li>
            <a href="/blog/2012/" class="year">2012</a>
            (<span class="post-count">10</span>)
          </li>
<li>
            <a href="/blog/2011/" class="year">2011</a>
            (<span class="post-count">1</span>)
          </li>
<li>
            <a href="/blog/2010/" class="year">2010</a>
            (<span class="post-count">5</span>)
          </li>
<li>
            <a href="/blog/2009/" class="year">2009</a>
            (<span class="post-count">9</span>)
          </li>
</ul>

      </aside>

    </div>

    <footer class="page-footer">
      <p>© 2009 – <span class="current-year">2021</span> Tom Dalling</p>

      <p class="social">
        <a href="https://twitter.com/tom_dalling">
          <i class="fa fa-lg fa-twitter"></i>
        </a>
        <a href="https://github.com/tomdalling">
          <i class="fa fa-lg fa-github"></i>
        </a>
        <a href="https://stackoverflow.com/users/108105/tom-dalling">
          <i class="fa fa-lg fa-stack-overflow"></i>
        </a>
        <a href="mailto:tom%20at%20tomdalling%20com">
          <i class="fa fa-lg fa-envelope"></i>
        </a>
      </p>
    </footer>

    <script src="/bundles/all.js"></script>
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        tex2jax: {
          inlineMath: [['$$','$$']],
          displayMath: [['[blockmath]', '[/blockmath]']]
        }
      });
    </script>
    <script type="text/javascript" async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>

  </body>
</html>
