<!DOCTYPE html>
<html lang="en">
  <head>
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-7X96B4HGF4"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-7X96B4HGF4');
    </script>

    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Modern OpenGL 05 – Model Assets &amp; Instances — Tom Dalling</title>
    <link rel="stylesheet" href="/style.css">
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet">

    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link href="https://fonts.googleapis.com/css2?family=Merriweather+Sans:wght@700&amp;family=Merriweather:ital,wght@0,400;0,700;1,400;1,700&amp;family=Montserrat:ital,wght@0,400;0,700;1,400&amp;display=swap" rel="stylesheet">

    <meta name="twitter:site" content="@tom_dalling">
    <meta name="twitter:creator" content="@tom_dalling">
    <link rel="alternate" type="application/rss+xml" title="Tom Dalling" href="https://www.tomdalling.com/blog/feed/">
  <link rel="canonical" href="https://www.tomdalling.com/blog/modern-opengl/05-model-assets-and-instances/">
<meta property="og:title" content="Modern OpenGL 05 – Model Assets &amp; Instances">
<meta property="og:url" content="https://www.tomdalling.com/blog/modern-opengl/05-model-assets-and-instances/">
<meta property="og:image" content="https://www.tomdalling.com/images/posts/modern-opengl-05.png">
<meta name="twitter:card" content="summary_large_image">
</head>

  <body>

    <header class="tw-mb-6 tw-py-2 tw-bg-gray-100 tw-border-b tw-border-gray-200 tw-font-title">
      <nav class="tw-container tw-mx-auto tw-max-w-screen-xl tw-space-x-8 tw-px-4">
        <a href="/" class="tw-text-xl tw-text-black">Tom Dalling</a>
        <a href="/blog/" class="tw-text-black">Blog</a>
      </nav>
    </header>

    <div class="tw-container tw-mx-auto tw-flex tw-flex-col lg:tw-flex-row">

      <main class="tw-flex-1 tw-min-w-0 tw-px-4"><article class="post post-single">

  <header>
    <h1><a href="/blog/modern-opengl/05-model-assets-and-instances/">Modern OpenGL 05 – Model Assets &amp; Instances</a></h1>
    <small class="meta">
      <span class="post-date">08 Feb, 2013</span>
      
      —
      Category: <a class="category" href="/blog/category/modern-opengl/">Modern OpenGL Series</a>
      —
      Suggest changes <a class="post-github" href="https://github.com/tomdalling/tomdalling.com/tree/main/input/posts/2013-02-08_05-model-assets-and-instances.markdown">on GitHub</a>
    </small>
    <div class="main-image">
      <img src="/images/posts/modern-opengl-05.png" class="img-responsive">
      
    </div>
  </header>

  <div class="post-content body-text">
<p>In this article, we will be refactoring the code to be more like a 3D
engine/framework. Specifically, we will be replacing some of the globals with
structs that represent “assets” and “instances.” At the end, we will have a
single wooden crate asset, and five instances of that asset arranged to spell
out “Hi” in 3D.</p>

<!--more-->
<p></p>
<div class="modern-opengl-preamble">
  <h2>Accessing The Code</h2>

  <p>
    Download all the code as a zip from here:
    <a href="https://github.com/tomdalling/opengl-series/archive/master.zip">
      https://github.com/tomdalling/opengl-series/archive/master.zip
    </a>
  </p>

  <p>
    All the code in this series of articles is available from github:
    <a href="https://github.com/tomdalling/opengl-series">https://github.com/tomdalling/opengl-series</a>.
    You can download a zip of all the files from that page, or you can clone the
    repository if you are familiar with git.
  </p>

  <p class="builds-on-previous">
    This article builds on the code from the previous article.
  </p>

  <p>
    The code for this article can be found in the
    <a class="source_folder" href="https://github.com/tomdalling/opengl-series/tree/master/source/05_asset_instance">
      <code>source/05_asset_instance</code>
    </a>
    folder. On OS X, open the <code>opengl-series.xcodeproj</code> file in the
    root folder, and select the target that corresponds with this article. On
    Windows, open the <code>opengl-series.sln</code> file in Visual Studio 2013,
    and open the project that corresponds with this article.
  </p>

  <p>
    The project includes all of its dependencies, so you shouldn't have to
    install or configure anything extra. Please let me know if you have
    any issues compiling and running the code.
  </p>
</div>


<h2>Assets, In General</h2>

<blockquote class="pull-right">
  For the purpose of this article, we will define an asset as a 3D object that
  can be drawn – often just referred to as a "model."
</blockquote>

<p>The term “asset” is very broad and can mean a variety of things. Other 3D
engines and frameworks might use the term “resources” instead of “assets.”
Often, the term “asset” includes things like music, sound effects, particle
emitters, shaders, meshes, game levels, etc. For the purpose of this article,
we will define an asset as a 3D object that can be drawn – often just referred
to as a “model.”</p>

<p>In more complicated 3D engines, a model is typically made up of <em>meshes</em> and
<em>materials</em>. A mesh typically contains the per-vertex data: the vertices,
texture coordinates, etc. A material typically contains the shaders, and some
values for uniform variables of the shader, for example: textures, colors,
shininess, etc. In the code for this article, we will not have separate classes
for meshes and materials. For simplicity, we will just have a single struct
called <code>ModelAsset</code> that is a combination of a material and a mesh.</p>

<h2>The ModelAsset Struct</h2>

<p>We will represent assets with this struct:</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">struct</span> <span class="nc">ModelAsset</span> <span class="p">{</span>
    <span class="n">tdogl</span><span class="o">::</span><span class="n">Program</span><span class="o">*</span> <span class="n">shaders</span><span class="p">;</span>
    <span class="n">tdogl</span><span class="o">::</span><span class="n">Texture</span><span class="o">*</span> <span class="n">texture</span><span class="p">;</span>
    <span class="n">GLuint</span> <span class="n">vbo</span><span class="p">;</span>
    <span class="n">GLuint</span> <span class="n">vao</span><span class="p">;</span>
    <span class="n">GLenum</span> <span class="n">drawType</span><span class="p">;</span>
    <span class="n">GLint</span> <span class="n">drawStart</span><span class="p">;</span>
    <span class="n">GLint</span> <span class="n">drawCount</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></div></div>

<p>Each asset contains shaders, a single texture, a VBO, VAO, and all the
parameters to <code>glDrawArrays</code>. Basically, it contains everything necessary to
draw a whole 3D object. We have seen all of these variables in previous
articles, but they were either globals or hard-coded constants. Grouping these
elements into a struct allows us to have multiple assets later on, for example:
a wooden crate, a teapot, and a tree.</p>

<p>You will notice that each asset has its own shader. This allows us to use
different shaders for different assets. A single shader can also be shared by
multiple assets, because it is stored as a pointer.</p>

<p>Each asset also has a single texture. Most 3D engines have multitexture
support, but we will just stick to a single texture per model for simplicity.</p>

<p>The VBO contains all the vertices and texture coordinates, the same as in the
previous articles.</p>

<p>The VAO is also the same as in previous articles.</p>

<p>The <code>drawType</code>, <code>drawStart</code> and <code>drawCount</code> variables will hold the parameters
to <code>glDrawArrays</code>. In the previous articles these three parameters were just
hard-coded constants, but they have become variables in order to make the code
more reusable.</p>

<h2>Instances, In General</h2>

<blockquote class="pull-right">
  An instance is an asset with an individual position, size, and other
  properties. The main reason why you separate assets from instances is that
  you can have multiple instances of a single asset.
</blockquote>

<p>An instance is an asset with an individual position, size, and other
properties. The main reason why you separate assets from instances is that you
can have multiple instances of a single asset. The fewer assets, the less video
memory you need.</p>

<p>For example, you can make a forest scene by creating 100 instances of a single
tree asset. Each instance would be in a different position, with a slightly
different size, and rotated a little bit. From the viewer’s perspective, it
looks like 100 different trees. From the programmer’s perspective, it is
actually just one tree that is drawn 100 times.</p>

<p><a name="instances-vs-entities"></a></p>

<h2>Instances vs Entities</h2>

<p>You may find that “instances” sound very similar to “entities” that you have
seen in other frameworks and engines. Indeed, they both have a position, a
size, a rotation, and you can draw them. You could design your code so that
instances and entities are the same thing, or maybe the <code>Entity</code> class inherits
from the <code>Instance</code> class, or vice versa. However, we can come up with a better
design than that.</p>

<p>In some situations it is nice to have entities that are not instances. For
example, maybe your camera is an entity – or maybe you have a “trigger” entity
that is invisible, but something happens when the player collides with it.</p>

<p>In other situations, you want to have instances that are not entities. For
example, maybe there is a static area of your game that the player can not get
to, so you just want to draw a bunch of instances without any of the other
features of entities, such as collision detection, animation, movement, etc.</p>

<p>From the examples above, we can conclude that entities and instances are
separate things, so one should not inherit from the other. A good rule of
thumb, no matter what you’re programming, is to <a href="http://www.learn-cocos2d.com/2010/06/prefer-composition-inheritance/">prefer composition to
inheritance</a>, so let’s do that.</p>

<p>A decent design would be for each entity to have an instance pointer. If the
instance pointer is null, then the entity can’t be drawn, and is invisible. If
you want instances that are <em>not</em> entities, you can do that too, because the
instances do not depend on entities in any way. Basically, the instance class
is <em>only used for drawing</em>, and the entity class contains the rest of the
functionality.</p>

<p>If you keep following this avenue of design, you eventually end up with an
<a href="http://t-machine.org/index.php/2007/11/11/entity-systems-are-the-future-of-mmog-development-part-2/">entity system</a> architecture. Entity system architectures are quite elegant,
in my opinion, and I might do an article about them in the future.</p>

<h2>The ModelInstance Struct</h2>

<p>We will represent instances with this struct:</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">struct</span> <span class="nc">ModelInstance</span> <span class="p">{</span>
    <span class="n">ModelAsset</span><span class="o">*</span> <span class="n">asset</span><span class="p">;</span>
    <span class="n">glm</span><span class="o">::</span><span class="n">mat4</span> <span class="n">transform</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></div></div>

<p>This struct is very simple. It only contains an asset and a transformation
matrix. A single matrix is all that is necessary to control the size, position,
and rotation of the instance. This per-instance matrix is often call the “model
matrix.”</p>

<p>In the code for this article, we have one asset and five instances. This means
the one asset will get drawn five times. Every time the asset gets drawn, it
will have a different transformation matrix applied, which will change the
position, size and rotation of the asset.</p>

<h2>Integrating ModelAsset and ModelInstance</h2>

<p>First lets look at how the globals have changed.</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// new globals this article</span>
<span class="n">ModelAsset</span> <span class="n">gWoodenCrate</span><span class="p">;</span> 
<span class="n">std</span><span class="o">::</span><span class="n">list</span><span class="o">&lt;</span><span class="n">ModelInstance</span><span class="o">&gt;</span> <span class="n">gInstances</span><span class="p">;</span>

<span class="c1">// deleted globals from last article</span>
<span class="cm">/*
tdogl::Texture* gTexture = NULL;
tdogl::Program* gProgram = NULL;
GLuint gVAO = 0;
GLuint gVBO = 0;
*/</span>

<span class="c1">// unchanged globals</span>
<span class="n">GLFWwindow</span><span class="o">*</span> <span class="n">gWindow</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="kt">double</span> <span class="n">gScrollY</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">;</span>
<span class="n">tdogl</span><span class="o">::</span><span class="n">Camera</span> <span class="n">gCamera</span><span class="p">;</span>
<span class="n">GLfloat</span> <span class="n">gDegreesRotated</span> <span class="o">=</span> <span class="mf">0.0</span><span class="n">f</span><span class="p">;</span>
</code></pre></div></div>

<p>The deleted globals are all part of the <code>ModelAsset</code> struct now. We only have a
single asset, so we’ll keep it in the global <code>gWoodenCrate</code> for now. Lastly, we
have a list of instances in the variable <code>gInstances</code>.</p>

<p>Now lets look in the start of the <code>LoadWoodenCrateAsset</code> function to see how
the asset is loaded:</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">static</span> <span class="kt">void</span> <span class="nf">LoadWoodenCrateAsset</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">gWoodenCrate</span><span class="p">.</span><span class="n">shaders</span> <span class="o">=</span> <span class="n">LoadShaders</span><span class="p">(</span><span class="s">"vertex-shader.txt"</span><span class="p">,</span> <span class="s">"fragment-shader.txt"</span><span class="p">);</span>
    <span class="n">gWoodenCrate</span><span class="p">.</span><span class="n">drawType</span> <span class="o">=</span> <span class="n">GL_TRIANGLES</span><span class="p">;</span>
    <span class="n">gWoodenCrate</span><span class="p">.</span><span class="n">drawStart</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">gWoodenCrate</span><span class="p">.</span><span class="n">drawCount</span> <span class="o">=</span> <span class="mi">6</span><span class="o">*</span><span class="mi">2</span><span class="o">*</span><span class="mi">3</span><span class="p">;</span>
    <span class="n">gWoodenCrate</span><span class="p">.</span><span class="n">texture</span> <span class="o">=</span> <span class="n">LoadTexture</span><span class="p">(</span><span class="s">"wooden-crate.jpg"</span><span class="p">);</span>
    <span class="n">glGenBuffers</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gWoodenCrate</span><span class="p">.</span><span class="n">vbo</span><span class="p">);</span>
    <span class="n">glGenVertexArrays</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gWoodenCrate</span><span class="p">.</span><span class="n">vao</span><span class="p">);</span>

    <span class="c1">//...</span>
</code></pre></div></div>

<p>The code is almost identical to the <code>LoadCube</code> function from the previous
article, except instead of setting global variables, it sets the variables
inside of <code>gWoodenCrate</code>. Also, the <code>LoadShaders</code> and <code>LoadTexture</code> functions
now return a value instead of setting a global. The fact that we are removing
the use of globals is an indication that the structure of the code is getting
better.</p>

<p>Now that we have seen how the asset is loaded, let’s look at how the instances
are made inside of the <code>CreateInstances</code> function:</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">static</span> <span class="kt">void</span> <span class="nf">CreateInstances</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">ModelInstance</span> <span class="n">dot</span><span class="p">;</span>
    <span class="n">dot</span><span class="p">.</span><span class="n">asset</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">gWoodenCrate</span><span class="p">;</span>
    <span class="n">dot</span><span class="p">.</span><span class="n">transform</span> <span class="o">=</span> <span class="n">glm</span><span class="o">::</span><span class="n">mat4</span><span class="p">();</span>
    <span class="n">gInstances</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">dot</span><span class="p">);</span>

    <span class="n">ModelInstance</span> <span class="n">i</span><span class="p">;</span>
    <span class="n">i</span><span class="p">.</span><span class="n">asset</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">gWoodenCrate</span><span class="p">;</span>
    <span class="n">i</span><span class="p">.</span><span class="n">transform</span> <span class="o">=</span> <span class="n">translate</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">4</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="n">scale</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
    <span class="n">gInstances</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>

    <span class="n">ModelInstance</span> <span class="n">hLeft</span><span class="p">;</span>
    <span class="n">hLeft</span><span class="p">.</span><span class="n">asset</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">gWoodenCrate</span><span class="p">;</span>
    <span class="n">hLeft</span><span class="p">.</span><span class="n">transform</span> <span class="o">=</span> <span class="n">translate</span><span class="p">(</span><span class="o">-</span><span class="mi">8</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="n">scale</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
    <span class="n">gInstances</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">hLeft</span><span class="p">);</span>

    <span class="n">ModelInstance</span> <span class="n">hRight</span><span class="p">;</span>
    <span class="n">hRight</span><span class="p">.</span><span class="n">asset</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">gWoodenCrate</span><span class="p">;</span>
    <span class="n">hRight</span><span class="p">.</span><span class="n">transform</span> <span class="o">=</span> <span class="n">translate</span><span class="p">(</span><span class="o">-</span><span class="mi">4</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="n">scale</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
    <span class="n">gInstances</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">hRight</span><span class="p">);</span>

    <span class="n">ModelInstance</span> <span class="n">hMid</span><span class="p">;</span>
    <span class="n">hMid</span><span class="p">.</span><span class="n">asset</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">gWoodenCrate</span><span class="p">;</span>
    <span class="n">hMid</span><span class="p">.</span><span class="n">transform</span> <span class="o">=</span> <span class="n">translate</span><span class="p">(</span><span class="o">-</span><span class="mi">6</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="n">scale</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mf">0.8</span><span class="p">);</span>
    <span class="n">gInstances</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">hMid</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>For each of the five instances, we set the asset to <code>&amp;gWoodenCrate</code>, then
set the transformation matrix to something unique, then append the instance to
the <code>gInstances</code> list.</p>

<p>The functions <code>translate</code> and <code>scale</code> are just convenience functions that
return matrices. The translation controls the position of the instance, and the
scale controls the size.</p>

<blockquote class="pull-right">
  The identity matrix is a special matrix that does <em>not</em> do any
  transformation.
</blockquote>

<p>Notice that the first instance does not have a transformation. The matrix for
this instance is the <em>identity matrix</em>. The identity matrix is a special matrix
that does <em>not</em> do any transformation. We are going to make this first instance
spin like in the previous article, so let’s look at the <code>Update</code> function to
see how that is done.</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">Update</span><span class="p">(</span><span class="kt">float</span> <span class="n">secondsElapsed</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">//rotate the first instance in `gInstances`</span>
    <span class="k">const</span> <span class="n">GLfloat</span> <span class="n">degreesPerSecond</span> <span class="o">=</span> <span class="mf">180.0</span><span class="n">f</span><span class="p">;</span>
    <span class="n">gDegreesRotated</span> <span class="o">+=</span> <span class="n">secondsElapsed</span> <span class="o">*</span> <span class="n">degreesPerSecond</span><span class="p">;</span>
    <span class="k">while</span><span class="p">(</span><span class="n">gDegreesRotated</span> <span class="o">&gt;</span> <span class="mf">360.0</span><span class="n">f</span><span class="p">)</span> <span class="n">gDegreesRotated</span> <span class="o">-=</span> <span class="mf">360.0</span><span class="n">f</span><span class="p">;</span>
    <span class="n">gInstances</span><span class="p">.</span><span class="n">front</span><span class="p">().</span><span class="n">transform</span> <span class="o">=</span> <span class="n">glm</span><span class="o">::</span><span class="n">rotate</span><span class="p">(</span><span class="n">glm</span><span class="o">::</span><span class="n">mat4</span><span class="p">(),</span> <span class="n">gDegreesRotated</span><span class="p">,</span> <span class="n">glm</span><span class="o">::</span><span class="n">vec3</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">));</span>

    <span class="c1">//...</span>

</code></pre></div></div>

<p>The only difference is the addition of that last statement:</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">gInstances</span><span class="p">.</span><span class="n">front</span><span class="p">().</span><span class="n">transform</span> <span class="o">=</span> <span class="n">glm</span><span class="o">::</span><span class="n">rotate</span><span class="p">(</span><span class="n">glm</span><span class="o">::</span><span class="n">mat4</span><span class="p">(),</span> <span class="n">gDegreesRotated</span><span class="p">,</span> <span class="n">glm</span><span class="o">::</span><span class="n">vec3</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">));</span>
</code></pre></div></div>

<p>This takes the first instance in <code>gInstances</code>, and sets the transformation
matrix based on the recently updated <code>gDegreesRotated</code> global.</p>

<p>Now that we have a list of instances to draw, let’s look at the <code>Render</code>
function:</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">static</span> <span class="kt">void</span> <span class="nf">Render</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">// clear everything</span>
    <span class="n">glClearColor</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span> <span class="c1">// black</span>
    <span class="n">glClear</span><span class="p">(</span><span class="n">GL_COLOR_BUFFER_BIT</span> <span class="o">|</span> <span class="n">GL_DEPTH_BUFFER_BIT</span><span class="p">);</span>
    
    <span class="c1">// render all the instances</span>
    <span class="n">std</span><span class="o">::</span><span class="n">list</span><span class="o">&lt;</span><span class="n">ModelInstance</span><span class="o">&gt;::</span><span class="n">const_iterator</span> <span class="n">it</span><span class="p">;</span>
    <span class="k">for</span><span class="p">(</span><span class="n">it</span> <span class="o">=</span> <span class="n">gInstances</span><span class="p">.</span><span class="n">begin</span><span class="p">();</span> <span class="n">it</span> <span class="o">!=</span> <span class="n">gInstances</span><span class="p">.</span><span class="n">end</span><span class="p">();</span> <span class="o">++</span><span class="n">it</span><span class="p">){</span>
        <span class="n">RenderInstance</span><span class="p">(</span><span class="o">*</span><span class="n">it</span><span class="p">);</span>
    <span class="p">}</span>
    
    <span class="c1">// swap the display buffers (displays what was just drawn)</span>
    <span class="n">glfwSwapBuffers</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div></div>

<p>This function is simpler than in the last article. Now, it just loops over the
<code>gInstances</code> list, and calls <code>RenderInstance</code> for every instance. Let’s look in
<code>RenderInstance</code>:</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">static</span> <span class="kt">void</span> <span class="nf">RenderInstance</span><span class="p">(</span><span class="k">const</span> <span class="n">ModelInstance</span><span class="o">&amp;</span> <span class="n">inst</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">ModelAsset</span><span class="o">*</span> <span class="n">asset</span> <span class="o">=</span> <span class="n">inst</span><span class="p">.</span><span class="n">asset</span><span class="p">;</span>
    <span class="n">tdogl</span><span class="o">::</span><span class="n">Program</span><span class="o">*</span> <span class="n">shaders</span> <span class="o">=</span> <span class="n">asset</span><span class="o">-&gt;</span><span class="n">shaders</span><span class="p">;</span>

    <span class="c1">//bind the shaders</span>
    <span class="n">shaders</span><span class="o">-&gt;</span><span class="n">use</span><span class="p">();</span>

    <span class="c1">//set the shader uniforms</span>
    <span class="n">shaders</span><span class="o">-&gt;</span><span class="n">setUniform</span><span class="p">(</span><span class="s">"camera"</span><span class="p">,</span> <span class="n">gCamera</span><span class="p">.</span><span class="n">matrix</span><span class="p">());</span>
    <span class="n">shaders</span><span class="o">-&gt;</span><span class="n">setUniform</span><span class="p">(</span><span class="s">"model"</span><span class="p">,</span> <span class="n">inst</span><span class="p">.</span><span class="n">transform</span><span class="p">);</span>
    <span class="n">shaders</span><span class="o">-&gt;</span><span class="n">setUniform</span><span class="p">(</span><span class="s">"tex"</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span> <span class="c1">//set to 0 because the texture will be bound to GL_TEXTURE0</span>

    <span class="c1">//bind the texture</span>
    <span class="n">glActiveTexture</span><span class="p">(</span><span class="n">GL_TEXTURE0</span><span class="p">);</span>
    <span class="n">glBindTexture</span><span class="p">(</span><span class="n">GL_TEXTURE_2D</span><span class="p">,</span> <span class="n">asset</span><span class="o">-&gt;</span><span class="n">texture</span><span class="o">-&gt;</span><span class="n">object</span><span class="p">());</span>

    <span class="c1">//bind VAO and draw</span>
    <span class="n">glBindVertexArray</span><span class="p">(</span><span class="n">asset</span><span class="o">-&gt;</span><span class="n">vao</span><span class="p">);</span>
    <span class="n">glDrawArrays</span><span class="p">(</span><span class="n">asset</span><span class="o">-&gt;</span><span class="n">drawType</span><span class="p">,</span> <span class="n">asset</span><span class="o">-&gt;</span><span class="n">drawStart</span><span class="p">,</span> <span class="n">asset</span><span class="o">-&gt;</span><span class="n">drawCount</span><span class="p">);</span>

    <span class="c1">//unbind everything</span>
    <span class="n">glBindVertexArray</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
    <span class="n">glBindTexture</span><span class="p">(</span><span class="n">GL_TEXTURE_2D</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="n">shaders</span><span class="o">-&gt;</span><span class="n">stopUsing</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div></div>

<p>The code comments explain the steps of the function fairly well. The code in
this function is almost identical to the code inside <code>Render</code> in the previous
article, except it uses a <code>ModelInstance</code> object instead of globals.</p>

<p>That’s pretty much it. We have restructured the code into assets and instances,
which is much more flexible than using globals. To test out the flexibility,
try adding some more instances. Or, if you’re brave, try adding a new asset
with a different texture, or different shaders.</p>

<h2>Optimisation</h2>

<p>The code in this article is naïve, and unoptimised. It still runs fast enough,
so it’s not a problem at this stage. However, there are a few fairly simple
optimisations that would make the rendering faster.</p>

<p>The current implementation binds and unbinds the same shader five times. If the
shader is the same for all five instances, then it only needs to be bound once.
In pseudocode, a more-optimised render loop would look something like this:</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">currentShader</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

<span class="n">foreach</span><span class="p">(</span><span class="n">instance</span> <span class="n">in</span> <span class="n">gInstances</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="n">instance</span><span class="p">.</span><span class="n">asset</span><span class="p">.</span><span class="n">shader</span> <span class="o">!=</span> <span class="n">currentShader</span><span class="p">){</span>
        <span class="k">if</span><span class="p">(</span><span class="n">currentShader</span><span class="p">)</span> <span class="n">currentShader</span><span class="p">.</span><span class="n">stopUsing</span><span class="p">();</span>
        <span class="n">currentShader</span> <span class="o">=</span> <span class="n">instance</span><span class="p">.</span><span class="n">asset</span><span class="p">.</span><span class="n">shader</span><span class="p">;</span>
        <span class="n">currentShader</span><span class="p">.</span><span class="n">use</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="n">RenderInstance</span><span class="p">(</span><span class="n">instance</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">currentShader</span><span class="p">.</span><span class="n">stopUsing</span><span class="p">();</span>
</code></pre></div></div>

<p>This way, if the shader doesn’t change, then it doesn’t get unbound. Binding
and unbinding shaders is a relatively expensive operation, so eliminating
unnecessary shader bindings will speed up the loop.</p>

<p>To make this work with multiple different shaders, you would need to sort the
<code>gInstances</code> list by shader. That way, all the instances with the same shader
will be grouped together, so each shader will only get bound once.</p>

<p>The next most expensive operation is binding the texture for each instance. We
can optimise texture binding in the exact same way as shader binding. Sort the
instances by shader, then by texture. Inside the loop, check if the correct
texture is already bound, and, if so, don’t unbind and rebind it.</p>

<h2>Scene Graphs</h2>

<p>In other engines/frameworks, you may find that instances are stored
<em>hierarchically</em> – that is, they are stored in a <em>tree</em> structure instead of
the <code>std::list</code> that we are using. Instances might be referred to as “nodes.”
Each instance would have a parent and multiple children. This is basically the
definition of a <a href="http://en.wikipedia.org/wiki/Scene_graph">scene graph</a>.</p>

<p>It’s possible to have both a list of instances <em>and</em> a scene graph. If you use
the same design rationale explained in the <a href="#instances-vs-entities">Instances vs Entities</a> section of
this article, the solution would be for each scene graph node to have a pointer
to an instance. Keeping a list of instances separate to the scene graph could
be helpful when it comes to optimisation.</p>

<p>We don’t require a scene graph yet, so let’s ignore them for now.</p>

<h2>OpenGL Instanced Rendering Functionality</h2>

<p>There is an OpenGL extension called <a href="http://www.opengl.org/registry/specs/ARB/draw_instanced.txt">ARB_draw_instanced</a> that provides
functions for doing what was described in this article. It involves putting the
model matrices into a VBO, and calling <code>glDrawArraysInstanced</code> instead of
<code>glDrawArrays</code>. It can be used to get better performance when rendering many
thousands of instances of the same asset. It would be overkill to use it to
draw five instances of a cube, but if you ever need to draw a fudge-tonne of
instances then you should consider using it.</p>

<p>This functionality became available in OpenGL ES 3, which means it’s <em>not</em>
available on most mobile devices that exist right now. On the desktop, it is
available in OpenGL 2.1 as an extension, and became part of the core profile in
OpenGL 3.1.</p>

<h2>Future Article Sneak Peek</h2>

<p>In the next article, we will begin to implement lighting, starting with diffuse
reflection of a single point light.</p>

<h2>Additional Resources</h2>

<ul>
  <li>It may be interesting to look at the structure of various 3D engines, such
as <a href="http://docs.unity3d.com/Documentation/Components/comp-AssetsGroup.html">Unity</a>, <a href="http://irrlicht.sourceforge.net/docu/index.html">Irrlicht</a>, <a href="http://www.ogre3d.org/docs/manual/manual_9.html">Ogre3D</a> and <a href="http://libgdx.badlogicgames.com/nightlies/docs/api/com/badlogic/gdx/graphics/g3d/model/Model.html">libgdx</a>.</li>
  <li>A <a href="http://www.learn-cocos2d.com/2010/06/prefer-composition-inheritance/">nice article, including a video, about composition vs inheritance in
game programming</a>
</li>
  <li>
<a href="http://www.opengl.org/wiki/Vertex_Rendering#Instancing">An explanation of ARB_draw_instanced</a> on the OpenGL wiki</li>
  <li>
<a href="http://entity-systems.wikidot.com/es-approaches">Links to articles about entity systems</a> on the entity systems wiki</li>
</ul>

</div>

  <footer>
    <div class="tw-rounded-3xl tw-bg-pink-100 tw-p-8 tw-my-16 tw-text-center tw-bg-opacity-50">
      <p class="tw-text-2xl tw-uppercase tw-text-pink-900 tw-font-black tw-mb-4">Enjoy this?</p>

      <p class="tw-flex tw-flex-col sm:tw-flex-row tw-justify-center tw-item-center sm:tw-items-baseline">
        <a href="/feed/" class="tw-flex-1 tw-bg-pink-500 tw-py-3 tw-px-4 tw-rounded-lg tw-text-pink-100 tw-ring-2 tw-ring-pink-300 tw-max-w-52 hover:tw-text-white">Subscribe via RSS</a>
      </p>

      <p class="tw-text-center tw-mt-4 tw-mb-0 tw-text-pink-900">
        <em>Found a mistake?</em> Pull requests are welcome on
        <a href="https://github.com/tomdalling/tomdalling.com">GitHub</a>.
      </p>
</div>

    


    
      <h2>Comments</h2>
      <div id="disqus_thread"></div>
      <script type="text/javascript" id="disqus_script">
        var disqus_shortname = "tomdalling";
        var disqus_identifier = "1104 http://tomdalling.com/?p=1104";
        var disqus_title = "Modern OpenGL 05 – Model Assets & Instances";
        var disqus_url = "https://www.tomdalling.com/blog/modern-opengl/05-model-assets-and-instances/";

        (function() {
          var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
          dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
          (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
      </script>
      <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments.</a>
</noscript>
    

  </footer>
</article>
</main>

      <aside class="tw-px-4 tw-text-center lg:tw-text-left lg:tw-w-1/3 tw-flex-none">

        <div class="tw-text-lg tw-font-title tw-mb-1">Subscribe</div>
        <ul class="tw-space-y-2">
          <li>
            <a href="/blog/feed/">
              <i class="fa fa-rss"></i> RSS
            </a>
          </li>
        </ul>

        <div class="tw-text-lg tw-font-title tw-mb-1 tw-mt-6">Recent Posts</div>
        <ul class="recent-posts tw-space-y-2">
          
        <li><a href="/blog/software-processes/toms-philosophy-of-project-management-for-software-development/">Tom's Philosophy Of Project Management For Software Development</a></li>
<li><a href="/blog/software-processes/leprechauns-root-causes-and-other-fairy-tails/">Leprechauns, Root Causes, And Other Fairy Tales</a></li>
<li><a href="/blog/software-processes/milestones-as-talking-points/">Milestones As Talking Points</a></li>
<li><a href="/blog/mentoring/work-in-thin-vertical-slices/">Work In Thin Vertical Slices</a></li>
<li><a href="/blog/management/the-difference-between-management-and-leadership/">The Difference Between Management And Leadership</a></li>
</ul>

        <div class="tw-text-lg tw-font-title tw-mb-1 tw-mt-6">Categories</div>
        <ul class="categories tw-space-y-2">
          
        <li>
            <a href="/blog/cocoa/" class="category">Cocoa</a>
            (<span class="post-count">5</span>
            <a class="feed" href="/blog/cocoa/feed/"><i class="fa fa-rss"></i></a>)
          </li>
<li>
            <a href="/blog/coding-styleconventions/" class="category">Coding Style/Conventions</a>
            (<span class="post-count">3</span>
            <a class="feed" href="/blog/coding-styleconventions/feed/"><i class="fa fa-rss"></i></a>)
          </li>
<li>
            <a href="/blog/coding-tips/" class="category">Coding Tips</a>
            (<span class="post-count">4</span>
            <a class="feed" href="/blog/coding-tips/feed/"><i class="fa fa-rss"></i></a>)
          </li>
<li>
            <a href="/blog/management/" class="category">Management</a>
            (<span class="post-count">1</span>
            <a class="feed" href="/blog/management/feed/"><i class="fa fa-rss"></i></a>)
          </li>
<li>
            <a href="/blog/mentoring/" class="category">Mentoring Notes</a>
            (<span class="post-count">4</span>
            <a class="feed" href="/blog/mentoring/feed/"><i class="fa fa-rss"></i></a>)
          </li>
<li>
            <a href="/blog/random-stuff/" class="category">Miscellaneous</a>
            (<span class="post-count">5</span>
            <a class="feed" href="/blog/random-stuff/feed/"><i class="fa fa-rss"></i></a>)
          </li>
<li>
            <a href="/blog/modern-opengl/" class="category">Modern OpenGL Series</a>
            (<span class="post-count">10</span>
            <a class="feed" href="/blog/modern-opengl/feed/"><i class="fa fa-rss"></i></a>)
          </li>
<li>
            <a href="/blog/ruby/" class="category">Ruby</a>
            (<span class="post-count">2</span>
            <a class="feed" href="/blog/ruby/feed/"><i class="fa fa-rss"></i></a>)
          </li>
<li>
            <a href="/blog/software-design/" class="category">Software Design</a>
            (<span class="post-count">12</span>
            <a class="feed" href="/blog/software-design/feed/"><i class="fa fa-rss"></i></a>)
          </li>
<li>
            <a href="/blog/software-processes/" class="category">Software Processes</a>
            (<span class="post-count">13</span>
            <a class="feed" href="/blog/software-processes/feed/"><i class="fa fa-rss"></i></a>)
          </li>
<li>
            <a href="/blog/testing/" class="category">Testing</a>
            (<span class="post-count">2</span>
            <a class="feed" href="/blog/testing/feed/"><i class="fa fa-rss"></i></a>)
          </li>
<li>
            <a href="/blog/web/" class="category">Web</a>
            (<span class="post-count">1</span>
            <a class="feed" href="/blog/web/feed/"><i class="fa fa-rss"></i></a>)
          </li>
</ul>

        <div class="tw-text-lg tw-font-title tw-mb-1 tw-mt-6">Archives</div>
        <ul class="archives tw-space-y-2">
          
        <li>
            <a href="/blog/2025/" class="year">2025</a>
            (<span class="post-count">7</span>)
          </li>
<li>
            <a href="/blog/2024/" class="year">2024</a>
            (<span class="post-count">2</span>)
          </li>
<li>
            <a href="/blog/2023/" class="year">2023</a>
            (<span class="post-count">5</span>)
          </li>
<li>
            <a href="/blog/2022/" class="year">2022</a>
            (<span class="post-count">1</span>)
          </li>
<li>
            <a href="/blog/2021/" class="year">2021</a>
            (<span class="post-count">6</span>)
          </li>
<li>
            <a href="/blog/2020/" class="year">2020</a>
            (<span class="post-count">5</span>)
          </li>
<li>
            <a href="/blog/2016/" class="year">2016</a>
            (<span class="post-count">1</span>)
          </li>
<li>
            <a href="/blog/2015/" class="year">2015</a>
            (<span class="post-count">2</span>)
          </li>
<li>
            <a href="/blog/2014/" class="year">2014</a>
            (<span class="post-count">3</span>)
          </li>
<li>
            <a href="/blog/2013/" class="year">2013</a>
            (<span class="post-count">5</span>)
          </li>
<li>
            <a href="/blog/2012/" class="year">2012</a>
            (<span class="post-count">10</span>)
          </li>
<li>
            <a href="/blog/2011/" class="year">2011</a>
            (<span class="post-count">1</span>)
          </li>
<li>
            <a href="/blog/2010/" class="year">2010</a>
            (<span class="post-count">5</span>)
          </li>
<li>
            <a href="/blog/2009/" class="year">2009</a>
            (<span class="post-count">9</span>)
          </li>
</ul>

      </aside>

    </div>

    <footer class="page-footer">
      <p>© 2009 – <span class="current-year">2025</span> Tom Dalling</p>

      <p class="social">
        <a href="https://github.com/tomdalling">
          <i class="fa fa-lg fa-github"></i>
        </a>
        <a href="https://stackoverflow.com/users/108105/tom-dalling">
          <i class="fa fa-lg fa-stack-overflow"></i>
        </a>
        <a href="mailto:tom%20at%20tomdalling%20com">
          <i class="fa fa-lg fa-envelope"></i>
        </a>
      </p>
    </footer>

    <script src="/bundles/all.js"></script>
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        tex2jax: {
          inlineMath: [['$$','$$']],
          displayMath: [['[blockmath]', '[/blockmath]']]
        }
      });
    </script>
    <script type="text/javascript" async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>

  </body>
</html>
