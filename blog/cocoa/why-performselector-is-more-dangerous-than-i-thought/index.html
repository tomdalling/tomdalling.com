<!DOCTYPE html>
<html lang="en">
  <head>
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-7X96B4HGF4"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-7X96B4HGF4');
    </script>

    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Why performSelector: Is More Dangerous Than I Thought — Tom Dalling</title>
    <link rel="stylesheet" href="/style.css">
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet">

    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link href="https://fonts.googleapis.com/css2?family=Merriweather+Sans:wght@700&amp;family=Merriweather:ital,wght@0,400;0,700;1,400;1,700&amp;family=Montserrat:ital,wght@0,400;0,700;1,400&amp;display=swap" rel="stylesheet">

    <meta name="twitter:site" content="@tom_dalling">
    <meta name="twitter:creator" content="@tom_dalling">
    <link rel="alternate" type="application/rss+xml" title="Tom Dalling" href="https://www.tomdalling.com/blog/feed/">
  <link rel="canonical" href="https://www.tomdalling.com/blog/cocoa/why-performselector-is-more-dangerous-than-i-thought/">
<meta property="og:title" content="Why performSelector: Is More Dangerous Than I Thought">
<meta property="og:url" content="https://www.tomdalling.com/blog/cocoa/why-performselector-is-more-dangerous-than-i-thought/">
<meta name="twitter:card" content="summary">
</head>

  <body>

    <header class="tw-mb-6 tw-py-2 tw-bg-gray-100 tw-border-b tw-border-gray-200 tw-font-title">
      <nav class="tw-container tw-mx-auto tw-max-w-screen-xl tw-space-x-8 tw-px-4">
        <a href="/" class="tw-text-xl tw-text-black">Tom Dalling</a>
        <a href="/blog/" class="tw-text-black">Blog</a>
      </nav>
    </header>

    <div class="tw-container tw-mx-auto tw-flex tw-flex-col lg:tw-flex-row">

      <main class="tw-flex-1 tw-min-w-0 tw-px-4"><article class="post post-single">

  <header>
    <h1><a href="/blog/cocoa/why-performselector-is-more-dangerous-than-i-thought/">Why performSelector: Is More Dangerous Than I Thought</a></h1>
    <small class="meta">
      <span class="post-date">14 May, 2010</span>
      
      —
      Category: <a class="category" href="/blog/category/cocoa/">Cocoa</a>
      —
      Suggest changes <a class="post-github" href="https://github.com/tomdalling/tomdalling.com/tree/main/input/posts/2010-05-14_why-performselector-is-more-dangerous-than-i-thought.markdown">on GitHub</a>
    </small>
    
  </header>

  <div class="post-content body-text">
<p>I fixed a rather nasty bug today in <a href="http://github.com/tomdalling/AspectObjectiveC">AspectObjectiveC</a>. One particular unit
test would crash with <code>EXC_BAD_ACCESS</code> every time. After learning far more
about registers and ABIs than I ever wanted to know (thanks, <a href="http://www.sealiesoftware.com/blog/archive/2008/10/30/objc_explain_objc_msgSend_stret.html" title="[objc explain]: objc_msgSend_stret">Greg Parker</a>),
it dawned on me that <code>performSelector:</code> <strong>was corrupting memory</strong>. It was
particularly hard to track down because the crash would happen a couple of
lines <em>after</em> the call to <code>performSelector:</code>, when the corrupted memory was
actually accessed.</p>

<p>I’ve never had a problem with <code>performSelector:</code> before, but this time I was
using it a little differently. The return value of the selector was an
<code>NSRect</code>.</p>

<p>Now for the gory explanation.</p>

<!--more-->

<h2>Why Returning an NSRect Caused the Memory Corruption</h2>

<p>Normally on Intel architectures, the return value for a function is stored in
the register <code>eax</code>. This is what <code>obj_msgSend</code> handles.</p>

<p>There is an exception to this rule when the function returns a sufficiently
large struct, such as an <code>NSRect</code>. In such cases, the function is passed a
secret extra argument: a pointer to some memory that will hold the return
value. The Objective-C runtime has a different message dispatch function for
these exceptional cases: <code>objc_msgSend_stret</code> (“stret” is short for
“struct return”). Therein lies the problem.</p>

<p>The documentation for <code>performSelector:</code> states:</p>

<blockquote>
  <p>For methods that return anything other than an object, use <code>NSInvocation</code>.</p>
</blockquote>

<p>Apple aren’t kidding when they mention this. This is because <code>performSelector:</code>
uses <code>objc_msgSend</code>. If you use <code>objc_msgSend</code> to call a method that requires
<code>objc_msgSend_stret</code>, the function will think the first parameter is the secret
struct pointer, when in fact it’s the <code>self</code> pointer. When the function
returns, it corrupts the memory pointed to by <code>self</code> by overwriting it with the
return value. Next time you try to use the object, you get weird and wonderful
crashes.</p>

<h2>The Moral of the Story</h2>

<p>Only use <code>performSelector:</code> when the selector returns an object. If the
selector returns a struct, then you risk corrupting memory, even if you don’t
use the return value. If the method doesn’t return an object, then use
NSInvocation instead, because it is capable of determining the correct message
dispatch function to use.</p>

<h2>Wrap Yourself In Cotton Wool</h2>

<p>For those of you who are overly cautious, here’s a method that will check the
return type before calling <code>performSelector:</code></p>

<div class="language-objc highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">@interface</span> <span class="nc">NSObject</span><span class="p">(</span><span class="nl">SafePerformSelector</span><span class="p">)</span>
<span class="k">-</span><span class="p">(</span><span class="n">id</span><span class="p">)</span> <span class="nf">performSelectorSafely</span><span class="p">:(</span><span class="n">SEL</span><span class="p">)</span><span class="nv">aSelector</span><span class="p">;</span>
<span class="k">@end</span>

<span class="k">@implementation</span> <span class="nc">NSObject</span><span class="p">(</span><span class="nl">SafePerformSelector</span><span class="p">)</span>
<span class="k">-</span><span class="p">(</span><span class="n">id</span><span class="p">)</span> <span class="nf">performSelectorSafely</span><span class="p">:(</span><span class="n">SEL</span><span class="p">)</span><span class="nv">aSelector</span><span class="p">;</span>
<span class="p">{</span>
    <span class="n">NSParameterAssert</span><span class="p">(</span><span class="n">aSelector</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span>
    <span class="n">NSParameterAssert</span><span class="p">([</span><span class="n">self</span> <span class="nf">respondsToSelector</span><span class="p">:</span><span class="n">aSelector</span><span class="p">]);</span>
    
    <span class="n">NSMethodSignature</span><span class="o">*</span> <span class="n">methodSig</span> <span class="o">=</span> <span class="p">[</span><span class="n">self</span> <span class="nf">methodSignatureForSelector</span><span class="p">:</span><span class="n">aSelector</span><span class="p">];</span>
    <span class="k">if</span><span class="p">(</span><span class="n">methodSig</span> <span class="o">==</span> <span class="nb">nil</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">nil</span><span class="p">;</span>
    
    <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">retType</span> <span class="o">=</span> <span class="p">[</span><span class="n">methodSig</span> <span class="nf">methodReturnType</span><span class="p">];</span>
    <span class="k">if</span><span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">retType</span><span class="p">,</span> <span class="k">@encode</span><span class="p">(</span><span class="n">id</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">strcmp</span><span class="p">(</span><span class="n">retType</span><span class="p">,</span> <span class="k">@encode</span><span class="p">(</span><span class="kt">void</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">){</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">self</span> <span class="nf">performSelector</span><span class="p">:</span><span class="n">aSelector</span><span class="p">];</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">NSLog</span><span class="p">(</span><span class="s">@"-[%@ performSelector:@selector(%@)] shouldn't be used. The selector doesn't return an object or void"</span><span class="p">,</span> <span class="p">[</span><span class="n">self</span> <span class="nf">className</span><span class="p">],</span> <span class="n">NSStringFromSelector</span><span class="p">(</span><span class="n">aSelector</span><span class="p">));</span>
        <span class="k">return</span> <span class="nb">nil</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="k">@end</span>
</code></pre></div></div>

</div>

  <footer>
    <div class="tw-rounded-3xl tw-bg-pink-100 tw-p-8 tw-my-16 tw-text-center tw-bg-opacity-50">
      <p class="tw-text-2xl tw-uppercase tw-text-pink-900 tw-font-black tw-mb-4">Enjoy this?</p>

      <p class="tw-flex tw-flex-col sm:tw-flex-row tw-justify-center tw-item-center sm:tw-items-baseline">
        <a href="/feed/" class="tw-flex-1 tw-bg-pink-500 tw-py-3 tw-px-4 tw-rounded-lg tw-text-pink-100 tw-ring-2 tw-ring-pink-300 tw-max-w-52 hover:tw-text-white">Subscribe via RSS</a>
      </p>

      <p class="tw-text-center tw-mt-4 tw-mb-0 tw-text-pink-900">
        <em>Found a mistake?</em> Pull requests are welcome on
        <a href="https://github.com/tomdalling/tomdalling.com">GitHub</a>.
      </p>
</div>

    


    
      <h2>Comments</h2>
      <div id="disqus_thread"></div>
      <script type="text/javascript" id="disqus_script">
        var disqus_shortname = "tomdalling";
        var disqus_identifier = "425 http://tomdalling.com/?p=425";
        var disqus_title = "Why performSelector: Is More Dangerous Than I Thought";
        var disqus_url = "https://www.tomdalling.com/blog/cocoa/why-performselector-is-more-dangerous-than-i-thought/";

        (function() {
          var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
          dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
          (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
      </script>
      <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments.</a>
</noscript>
    

  </footer>
</article>
</main>

      <aside class="tw-px-4 tw-text-center lg:tw-text-left lg:tw-w-1/3 tw-flex-none">

        <div class="tw-text-lg tw-font-title tw-mb-1">Subscribe</div>
        <ul class="tw-space-y-2">
          <li>
            <a href="/blog/feed/">
              <i class="fa fa-rss"></i> RSS
            </a>
          </li>
        </ul>

        <div class="tw-text-lg tw-font-title tw-mb-1 tw-mt-6">Recent Posts</div>
        <ul class="recent-posts tw-space-y-2">
          
        <li><a href="/blog/mentoring/work-in-thin-vertical-slices/">Work In Thin Vertical Slices</a></li>
<li><a href="/blog/management/the-difference-between-management-and-leadership/">The Difference Between Management And Leadership</a></li>
<li><a href="/blog/random-stuff/feedback-is-a-gift/">Feedback Is Literally A Gift</a></li>
<li><a href="/blog/software-processes/against-must-haves-part-three/">Against Must-Haves (Part Three)</a></li>
<li><a href="/blog/software-processes/high-performance-requires-process/">High Performance Requires Process</a></li>
</ul>

        <div class="tw-text-lg tw-font-title tw-mb-1 tw-mt-6">Categories</div>
        <ul class="categories tw-space-y-2">
          
        <li>
            <a href="/blog/cocoa/" class="category">Cocoa</a>
            (<span class="post-count">5</span>
            <a class="feed" href="/blog/cocoa/feed/"><i class="fa fa-rss"></i></a>)
          </li>
<li>
            <a href="/blog/coding-styleconventions/" class="category">Coding Style/Conventions</a>
            (<span class="post-count">3</span>
            <a class="feed" href="/blog/coding-styleconventions/feed/"><i class="fa fa-rss"></i></a>)
          </li>
<li>
            <a href="/blog/coding-tips/" class="category">Coding Tips</a>
            (<span class="post-count">4</span>
            <a class="feed" href="/blog/coding-tips/feed/"><i class="fa fa-rss"></i></a>)
          </li>
<li>
            <a href="/blog/management/" class="category">Management</a>
            (<span class="post-count">1</span>
            <a class="feed" href="/blog/management/feed/"><i class="fa fa-rss"></i></a>)
          </li>
<li>
            <a href="/blog/mentoring/" class="category">Mentoring Notes</a>
            (<span class="post-count">4</span>
            <a class="feed" href="/blog/mentoring/feed/"><i class="fa fa-rss"></i></a>)
          </li>
<li>
            <a href="/blog/random-stuff/" class="category">Miscellaneous</a>
            (<span class="post-count">5</span>
            <a class="feed" href="/blog/random-stuff/feed/"><i class="fa fa-rss"></i></a>)
          </li>
<li>
            <a href="/blog/modern-opengl/" class="category">Modern OpenGL Series</a>
            (<span class="post-count">10</span>
            <a class="feed" href="/blog/modern-opengl/feed/"><i class="fa fa-rss"></i></a>)
          </li>
<li>
            <a href="/blog/ruby/" class="category">Ruby</a>
            (<span class="post-count">2</span>
            <a class="feed" href="/blog/ruby/feed/"><i class="fa fa-rss"></i></a>)
          </li>
<li>
            <a href="/blog/software-design/" class="category">Software Design</a>
            (<span class="post-count">12</span>
            <a class="feed" href="/blog/software-design/feed/"><i class="fa fa-rss"></i></a>)
          </li>
<li>
            <a href="/blog/software-processes/" class="category">Software Processes</a>
            (<span class="post-count">10</span>
            <a class="feed" href="/blog/software-processes/feed/"><i class="fa fa-rss"></i></a>)
          </li>
<li>
            <a href="/blog/testing/" class="category">Testing</a>
            (<span class="post-count">2</span>
            <a class="feed" href="/blog/testing/feed/"><i class="fa fa-rss"></i></a>)
          </li>
<li>
            <a href="/blog/web/" class="category">Web</a>
            (<span class="post-count">1</span>
            <a class="feed" href="/blog/web/feed/"><i class="fa fa-rss"></i></a>)
          </li>
</ul>

        <div class="tw-text-lg tw-font-title tw-mb-1 tw-mt-6">Archives</div>
        <ul class="archives tw-space-y-2">
          
        <li>
            <a href="/blog/2025/" class="year">2025</a>
            (<span class="post-count">4</span>)
          </li>
<li>
            <a href="/blog/2024/" class="year">2024</a>
            (<span class="post-count">2</span>)
          </li>
<li>
            <a href="/blog/2023/" class="year">2023</a>
            (<span class="post-count">5</span>)
          </li>
<li>
            <a href="/blog/2022/" class="year">2022</a>
            (<span class="post-count">1</span>)
          </li>
<li>
            <a href="/blog/2021/" class="year">2021</a>
            (<span class="post-count">6</span>)
          </li>
<li>
            <a href="/blog/2020/" class="year">2020</a>
            (<span class="post-count">5</span>)
          </li>
<li>
            <a href="/blog/2016/" class="year">2016</a>
            (<span class="post-count">1</span>)
          </li>
<li>
            <a href="/blog/2015/" class="year">2015</a>
            (<span class="post-count">2</span>)
          </li>
<li>
            <a href="/blog/2014/" class="year">2014</a>
            (<span class="post-count">3</span>)
          </li>
<li>
            <a href="/blog/2013/" class="year">2013</a>
            (<span class="post-count">5</span>)
          </li>
<li>
            <a href="/blog/2012/" class="year">2012</a>
            (<span class="post-count">10</span>)
          </li>
<li>
            <a href="/blog/2011/" class="year">2011</a>
            (<span class="post-count">1</span>)
          </li>
<li>
            <a href="/blog/2010/" class="year">2010</a>
            (<span class="post-count">5</span>)
          </li>
<li>
            <a href="/blog/2009/" class="year">2009</a>
            (<span class="post-count">9</span>)
          </li>
</ul>

      </aside>

    </div>

    <footer class="page-footer">
      <p>© 2009 – <span class="current-year">2025</span> Tom Dalling</p>

      <p class="social">
        <a href="https://github.com/tomdalling">
          <i class="fa fa-lg fa-github"></i>
        </a>
        <a href="https://stackoverflow.com/users/108105/tom-dalling">
          <i class="fa fa-lg fa-stack-overflow"></i>
        </a>
        <a href="mailto:tom%20at%20tomdalling%20com">
          <i class="fa fa-lg fa-envelope"></i>
        </a>
      </p>
    </footer>

    <script src="/bundles/all.js"></script>
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        tex2jax: {
          inlineMath: [['$$','$$']],
          displayMath: [['[blockmath]', '[/blockmath]']]
        }
      });
    </script>
    <script type="text/javascript" async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>

  </body>
</html>
