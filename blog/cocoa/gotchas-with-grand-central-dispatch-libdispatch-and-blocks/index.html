<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Gotchas With Grand Central Dispatch (libdispatch) And Blocks — Tom Dalling</title>
    <link rel="stylesheet" href="/style.css">
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet">

    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link href="https://fonts.googleapis.com/css2?family=Merriweather+Sans:wght@700&amp;family=Merriweather:ital,wght@0,400;0,700;1,400;1,700&amp;family=Montserrat:ital,wght@0,400;0,700;1,400&amp;display=swap" rel="stylesheet">

    <meta name="twitter:site" content="@tom_dalling">
    <meta name="twitter:creator" content="@tom_dalling">
    <link rel="alternate" type="application/rss+xml" title="Tom Dalling" href="https://www.tomdalling.com/blog/feed/">
  <link rel="canonical" href="https://www.tomdalling.com/blog/cocoa/gotchas-with-grand-central-dispatch-libdispatch-and-blocks/">
<meta property="og:title" content="Gotchas With Grand Central Dispatch (libdispatch) And Blocks">
<meta property="og:url" content="https://www.tomdalling.com/blog/cocoa/gotchas-with-grand-central-dispatch-libdispatch-and-blocks/">
<meta name="twitter:card" content="summary">
</head>

  <body>

    <header class="tw-mb-6 tw-py-2 tw-bg-gray-100 tw-border-b tw-border-gray-200 tw-font-title">
      <nav class="tw-container tw-mx-auto max-w-screen-xl tw-space-x-8 tw-px-4">
        <a href="/" class="tw-text-xl tw-text-black">Tom Dalling</a>
        <a href="/blog/" class="tw-text-black">Blog</a>
      </nav>
    </header>

    <div class="tw-container tw-mx-auto tw-flex tw-flex-col lg:tw-flex-row">

      <main class="tw-flex-1 tw-min-w-0 tw-px-4"><article class="post post-single">

  <header>
    <h1><a href="/blog/cocoa/gotchas-with-grand-central-dispatch-libdispatch-and-blocks/">Gotchas With Grand Central Dispatch (libdispatch) And Blocks</a></h1>
    <small class="meta">
      <span class="post-date">02 Mar, 2012</span>
      
      —
      Category: <a class="category" href="/blog/category/cocoa/">Cocoa</a>
      —
      Suggest changes <a class="post-github" href="https://github.com/tomdalling/tomdalling.com/tree/main/input/posts/2012-03-02_gotchas-with-grand-central-dispatch-libdispatch-and-blocks.markdown">on GitHub</a>
    </small>
    
  </header>

  <div class="post-content body-text">
<p><a href="http://en.wikipedia.org/wiki/Grand_Central_Dispatch" title="Grand Central Dispatch">GCD</a> is a nice replacement for the old
<code><a href="https://developer.apple.com/library/mac/documentation/Cocoa/Reference/Foundation/Classes/nsobject_Class/Reference/Reference.html#//apple_ref/occ/instm/NSObject/performSelectorInBackground:withObject:">performSelectorInBackground:withObject:</a></code> and
<code><a href="https://developer.apple.com/library/mac/documentation/Cocoa/Reference/Foundation/Classes/nsobject_Class/Reference/Reference.html#//apple_ref/occ/instm/NSObject/performSelectorOnMainThread:withObject:waitUntilDone:">performSelectorOnMainThread:withObject:waitUntilDone:</a></code> methods
and <a href="https://developer.apple.com/library/mac/#documentation/Cocoa/Reference/NSOperation_class/Reference/Reference.html">NSOperation</a>. It’s also a nice supplement to <a href="https://developer.apple.com/library/mac/#documentation/Cocoa/Reference/Foundation/Classes/nsthread_Class/Reference/Reference.html">NSThread</a>.</p>

<p>However, I think it was over-hyped a little bit by Apple when it was first
released. You probably have all these random deadlocks and race conditions and
stuff whenever you use multiple threads, but GCD is <em>soooooo good</em> that you
don’t have to worry about that anymore. Just use these magic blocks.</p>

<p>The problem is that concurrent programming is notoriously hard to get right.
Maybe GCD helps to make it easier, but It doesn’t solve all of your problems.
In fact, GCD and blocks introduce some problems of their own. This article will
focus on some of those problems.</p>

<!--more-->

<h2>Blocks Are Stack Allocated</h2>

<p>Invariably, when you start using blocks you will find out the hard way that
blocks are allocated on the stack. It is natural to think along the lines of:
<em>“Blocks are objects in Objective-C, right? I’ll just retain it and use it
later.”</em> But when you go to use the block, you get weird crashes that are hard
to debug.</p>

<p>Stack allocated memory is deallocated when it goes out of scope. If you make a
block inside of a method then it is deallocated when the method finishes,
regardless of how many times it is retained. You need to copy the block if you
want it to survive going out of scope, because copied blocks are heap
allocated.</p>

<h2>Dispatch Barriers</h2>

<p>GCD has the ability to dispatch “barriers”. When a block is dispatched as a
barrier, it will not run until all blocks before it in the queue have finished.
Then, once it is guaranteed to be the only thing running in the dispatch queue,
the block is run until completion. Once the barrier block has finished, the
queue resumes executing blocks as it normally would.</p>

<p>Barriers have their uses, but they also introduce a problem. Let’s say you have
a block running on the default priority global queue and it needs to pop back
onto the main thread, so it does a <code>dispatch_sync</code> onto the main queue.
Meanwhile, over on the main thread, someone decides to do a
<code>dispatch_barrier_sync</code> onto the default priority global queue. Now you have a
deadlock. The main thread is waiting on the barrier, the barrier won’t execute
because it’s waiting on the block in front, and the block in front won’t
execute because it’s waiting on the main thread.</p>

<p><strong>Any time you <code>dispatch_sync</code> to the main thread from one of the global queues
– which is extremely common – you risk deadlock.</strong></p>

<p>You’re probably thinking that dispatching a barrier from the main thread to a
shared global queue is a horrible idea, and that nobody should be doing it in
the first place. I totally agree with you. Unfortunately, this is exactly what
Apple does. I have come across this exact bug when clicking a toolbar item.
Deep inside Apple frameworks, code which I assume is responsible for darkening
the image of the toolbar item calls <code>dispatch_barrier_sync</code>. I wish I could
find a screenshot I took of the stack trace, but alas I can not. I assume this
is a bug, and I expect it will be fixed eventually, but you can’t rely on third
party code playing nicely with the global queues.</p>

<p>Remember how everyone told you globals were bad? This is exactly why.</p>

<p>The solution is to make your own dispatch queue instead of using the global
ones. Third party code can’t dispatch a barrier onto your queue if they don’t
have a pointer to it.</p>

<h2>512 Thread Limit</h2>

<p>GCD tries to hide the use of threads with abstraction, but the <a href="http://en.wikipedia.org/wiki/Leaky_abstraction" title="Leaky abstraction">abstraction is
leaky</a>. The threads are still there, lurking just below the surface. If
you’re not careful, you may find that you hit the 512 thread limit
accidentally, and then GCD will start going weird on you.</p>

<p>Every time a queue wants to run a block, GCD tries to reuse a thread that has
finished running a block and is now doing nothing. However, if all the threads
are busy running their blocks then GCD will create a new thread for you.</p>

<p>Let’s say you are about to add more than 512 blocks to queues. If the blocks
finish fairly quickly then there is no problem, because the threads will be
reused. But what if, instead of finishing quickly, they all start waiting on a
lock? Now you have a problem. Every time you add a new block it looks for
threads to reuse, but all the threads are busy waiting on a lock, so GCD makes
a new thread for you. Every block ends up with its own thread, and now you’ve
accidentally hit the thread limit.</p>

<p>There isn’t a whole lot of documentation about this, but if you click “Sample
Process” from Activity Monitor, it will tell you when you have hit the 512
thread limit. If your app locks up and you can’t work out why, it might be
worth checking.</p>

<p>To solve this one, you might want to add your blocks to serial queues. The
serial queues basically have a single thread, and execute the blocks one at a
time. You’ll be fine as long as you don’t have 512 serial queues all running at
once.</p>

</div>

  <footer>
    <div class="tw-rounded-3xl tw-bg-pink-100 tw-p-8 tw-my-16 tw-text-center tw-bg-opacity-50">
      <p class="tw-text-2xl tw-uppercase tw-text-pink-900 tw-font-black tw-mb-4">Enjoy this?</p>

      <p class="tw-flex tw-flex-col sm:tw-flex-row tw-justify-center tw-item-center sm:tw-items-baseline">
        <a href="/feed/" class="tw-flex-1 tw-bg-pink-500 tw-py-3 tw-px-4 tw-rounded-lg tw-text-pink-100 tw-ring-2 tw-ring-pink-300 hover:tw-text-white">Subscribe via RSS</a>
        <span class="tw-flex-none tw-px-8 tw-py-4 tw-text-pink-800">or</span>
        <a href="https://twitter.com/tom_dalling" class="tw-flex-1 tw-bg-pink-500 tw-py-3 tw-px-4 tw-rounded-lg tw-text-pink-100 tw-ring-2 tw-ring-pink-300 hover:tw-text-white">Follow on Twitter</a>
      </p>

      <p class="tw-text-center tw-mt-4 tw-mb-0 tw-text-pink-900">
        <em>Found a mistake?</em> Pull requests are welcome on
        <a href="https://github.com/tomdalling/tomdalling.com/whatever">GitHub</a>.
      </p>
</div>

    


    
      <h2>Comments</h2>
      <div id="disqus_thread"></div>
      <script type="text/javascript" id="disqus_script">
        var disqus_shortname = "tomdalling";
        var disqus_identifier = "563 http://tomdalling.com/blog/?p=563";
        var disqus_title = "Gotchas With Grand Central Dispatch (libdispatch) And Blocks";
        var disqus_url = "https://www.tomdalling.com/blog/cocoa/gotchas-with-grand-central-dispatch-libdispatch-and-blocks/";

        (function() {
          var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
          dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
          (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
      </script>
      <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments.</a>
</noscript>
    

  </footer>
</article>
</main>

      <aside class="tw-px-4 tw-text-center lg:tw-text-left lg:tw-w-1/3 tw-flex-none">

        <div class="tw-text-lg tw-font-title tw-mb-1">Subscribe</div>
        <ul class="tw-space-y-2">
          <li>
            <a href="/blog/feed/">
              <i class="fa fa-rss"></i> RSS
            </a>
          </li>
          <li>
            <a href="https://twitter.com/tom_dalling">
              <i class="fa fa-twitter"></i> Twitter
            </a>
          </li>
        </ul>

        <div class="tw-text-lg tw-font-title tw-mb-1 tw-mt-6">Recent Posts</div>
        <ul class="recent-posts tw-space-y-2">
          
        <li><a href="/blog/software-processes/against-must-haves-part-one/">Against Must-Haves (Part One)</a></li>
<li><a href="/blog/software-processes/agile-is-a-glass-cannon/">Agile Is A Glass Cannon</a></li>
<li><a href="/blog/mentoring/marketing-yourself-as-a-junior-engineer/">Marketing Yourself As A Junior Engineer</a></li>
<li><a href="/blog/random-stuff/context-costs-and-benefits/">Context, Costs, and Benefits</a></li>
<li><a href="/blog/software-design/thoughts-on-schema-library-design/">Thoughts On Schema Library Design</a></li>
</ul>

        <div class="tw-text-lg tw-font-title tw-mb-1 tw-mt-6">Categories</div>
        <ul class="categories tw-space-y-2">
          
        <li>
            <a href="/blog/cocoa/" class="category">Cocoa</a>
            (<span class="post-count">5</span>
            <a class="feed" href="/blog/cocoa/feed/"><i class="fa fa-rss"></i></a>)
          </li>
<li>
            <a href="/blog/coding-styleconventions/" class="category">Coding Style/Conventions</a>
            (<span class="post-count">3</span>
            <a class="feed" href="/blog/coding-styleconventions/feed/"><i class="fa fa-rss"></i></a>)
          </li>
<li>
            <a href="/blog/coding-tips/" class="category">Coding Tips</a>
            (<span class="post-count">4</span>
            <a class="feed" href="/blog/coding-tips/feed/"><i class="fa fa-rss"></i></a>)
          </li>
<li>
            <a href="/blog/mentoring/" class="category">Mentoring Notes</a>
            (<span class="post-count">3</span>
            <a class="feed" href="/blog/mentoring/feed/"><i class="fa fa-rss"></i></a>)
          </li>
<li>
            <a href="/blog/random-stuff/" class="category">Miscellaneous</a>
            (<span class="post-count">4</span>
            <a class="feed" href="/blog/random-stuff/feed/"><i class="fa fa-rss"></i></a>)
          </li>
<li>
            <a href="/blog/modern-opengl/" class="category">Modern OpenGL Series</a>
            (<span class="post-count">10</span>
            <a class="feed" href="/blog/modern-opengl/feed/"><i class="fa fa-rss"></i></a>)
          </li>
<li>
            <a href="/blog/ruby/" class="category">Ruby</a>
            (<span class="post-count">2</span>
            <a class="feed" href="/blog/ruby/feed/"><i class="fa fa-rss"></i></a>)
          </li>
<li>
            <a href="/blog/software-design/" class="category">Software Design</a>
            (<span class="post-count">12</span>
            <a class="feed" href="/blog/software-design/feed/"><i class="fa fa-rss"></i></a>)
          </li>
<li>
            <a href="/blog/software-processes/" class="category">Software Processes</a>
            (<span class="post-count">5</span>
            <a class="feed" href="/blog/software-processes/feed/"><i class="fa fa-rss"></i></a>)
          </li>
<li>
            <a href="/blog/testing/" class="category">Testing</a>
            (<span class="post-count">2</span>
            <a class="feed" href="/blog/testing/feed/"><i class="fa fa-rss"></i></a>)
          </li>
<li>
            <a href="/blog/web/" class="category">Web</a>
            (<span class="post-count">1</span>
            <a class="feed" href="/blog/web/feed/"><i class="fa fa-rss"></i></a>)
          </li>
</ul>

        <div class="tw-text-lg tw-font-title tw-mb-1 tw-mt-6">Archives</div>
        <ul class="archives tw-space-y-2">
          
        <li>
            <a href="/blog/2023/" class="year">2023</a>
            (<span class="post-count">3</span>)
          </li>
<li>
            <a href="/blog/2022/" class="year">2022</a>
            (<span class="post-count">1</span>)
          </li>
<li>
            <a href="/blog/2021/" class="year">2021</a>
            (<span class="post-count">6</span>)
          </li>
<li>
            <a href="/blog/2020/" class="year">2020</a>
            (<span class="post-count">5</span>)
          </li>
<li>
            <a href="/blog/2016/" class="year">2016</a>
            (<span class="post-count">1</span>)
          </li>
<li>
            <a href="/blog/2015/" class="year">2015</a>
            (<span class="post-count">2</span>)
          </li>
<li>
            <a href="/blog/2014/" class="year">2014</a>
            (<span class="post-count">3</span>)
          </li>
<li>
            <a href="/blog/2013/" class="year">2013</a>
            (<span class="post-count">5</span>)
          </li>
<li>
            <a href="/blog/2012/" class="year">2012</a>
            (<span class="post-count">10</span>)
          </li>
<li>
            <a href="/blog/2011/" class="year">2011</a>
            (<span class="post-count">1</span>)
          </li>
<li>
            <a href="/blog/2010/" class="year">2010</a>
            (<span class="post-count">5</span>)
          </li>
<li>
            <a href="/blog/2009/" class="year">2009</a>
            (<span class="post-count">9</span>)
          </li>
</ul>

      </aside>

    </div>

    <footer class="page-footer">
      <p>© 2009 – <span class="current-year">2023</span> Tom Dalling</p>

      <p class="social">
        <a href="https://twitter.com/tom_dalling">
          <i class="fa fa-lg fa-twitter"></i>
        </a>
        <a href="https://github.com/tomdalling">
          <i class="fa fa-lg fa-github"></i>
        </a>
        <a href="https://stackoverflow.com/users/108105/tom-dalling">
          <i class="fa fa-lg fa-stack-overflow"></i>
        </a>
        <a href="mailto:tom%20at%20tomdalling%20com">
          <i class="fa fa-lg fa-envelope"></i>
        </a>
      </p>
    </footer>

    <script src="/bundles/all.js"></script>
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        tex2jax: {
          inlineMath: [['$$','$$']],
          displayMath: [['[blockmath]', '[/blockmath]']]
        }
      });
    </script>
    <script type="text/javascript" async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>

  </body>
</html>
