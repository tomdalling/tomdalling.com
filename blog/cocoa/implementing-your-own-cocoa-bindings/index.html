<!DOCTYPE html>
<html lang="en">
  <head>
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-7X96B4HGF4"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-7X96B4HGF4');
    </script>

    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Implementing Your Own Cocoa Bindings — Tom Dalling</title>
    <link rel="stylesheet" href="/style.css">
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet">

    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link href="https://fonts.googleapis.com/css2?family=Merriweather+Sans:wght@700&amp;family=Merriweather:ital,wght@0,400;0,700;1,400;1,700&amp;family=Montserrat:ital,wght@0,400;0,700;1,400&amp;display=swap" rel="stylesheet">

    <meta name="twitter:site" content="@tom_dalling">
    <meta name="twitter:creator" content="@tom_dalling">
    <link rel="alternate" type="application/rss+xml" title="Tom Dalling" href="https://www.tomdalling.com/blog/feed/">
  <link rel="canonical" href="https://www.tomdalling.com/blog/cocoa/implementing-your-own-cocoa-bindings/">
<meta property="og:title" content="Implementing Your Own Cocoa Bindings">
<meta property="og:url" content="https://www.tomdalling.com/blog/cocoa/implementing-your-own-cocoa-bindings/">
<meta name="twitter:card" content="summary">
</head>

  <body>

    <header class="tw-mb-6 tw-py-2 tw-bg-gray-100 tw-border-b tw-border-gray-200 tw-font-title">
      <nav class="tw-container tw-mx-auto max-w-screen-xl tw-space-x-8 tw-px-4">
        <a href="/" class="tw-text-xl tw-text-black">Tom Dalling</a>
        <a href="/blog/" class="tw-text-black">Blog</a>
      </nav>
    </header>

    <div class="tw-container tw-mx-auto tw-flex tw-flex-col lg:tw-flex-row">

      <main class="tw-flex-1 tw-min-w-0 tw-px-4"><article class="post post-single">

  <header>
    <h1><a href="/blog/cocoa/implementing-your-own-cocoa-bindings/">Implementing Your Own Cocoa Bindings</a></h1>
    <small class="meta">
      <span class="post-date">31 Jul, 2009</span>
      
      —
      Category: <a class="category" href="/blog/category/cocoa/">Cocoa</a>
      —
      Suggest changes <a class="post-github" href="https://github.com/tomdalling/tomdalling.com/tree/main/input/posts/2009-07-31_implementing-your-own-cocoa-bindings.markdown">on GitHub</a>
    </small>
    
  </header>

  <div class="post-content body-text">
<p>This post is the result of investigation into a <a href="http://stackoverflow.com/questions/1169097/can-you-manually-implement-cocoa-bindings" title="Can you manually implement Cocoa bindings?">stackoverflow.com question of
mine</a>.</p>

<p>So, you’ve created a spiffy <code>NSView</code> of your own, and have decided to make it
compatible with bindings. Great! So you go and read the <a href="http://developer.apple.com/documentation/Cocoa/Conceptual/CocoaBindings/Concepts/HowDoBindingsWork.html" title="How Do Bindings Work?">documentation</a>, and
you look at mmalc’s GraphicsBindings examples. You override
<code>bind:toObject:withKeyPath:options:</code> and everything works. But wait! Why isn’t
the <code>NSWindowController</code> ever being deallocated anymore?</p>

<p>Now you’ve got a nasty retain cycle on your hands. You do a little research and
discover that not only do <a href="http://www.cocoabuilder.com/archive/message/cocoa/2004/6/12/109600" title="Retain cycle problem with bindings &amp; NSWindowController">other people have the same problem</a>, but even
<a href="http://theocacao.com/document.page/18" title="Bindings and File's Owner">Apple’s bindings used to have it</a> a few years ago. How did Apple fix the
problem? With the magic, undocumented class <code>NSAutounbinder</code>, which <a href="http://www.google.com/search?q=nsautounbinder">nobody
seems to know much about</a>.</p>

<p>Other people will tell you that you don’t need to override
<code>bind:toObject:withKeyPath:options:</code> and that bindings work automatically. This
is only a half truth. <code>NSObject</code> does provide an implementation of
<code>bind:toObject:withKeyPath:options:</code>, but it only half works. Using the default
<code>NSObject</code> implementation, changes in the model will update the view, but the
reverse is not true. When the bound property of the view changes, nothing
happens to the model.</p>

<p>So, what is a Cocoa developer to do? I’ll explain how to implement your own
bindings that work exactly like Apple’s, with no retain cycles. <del>I haven’t
found this solution anywhere else, so as far as I know, I’m the discoverer. I
feel so special.</del> It has been <a href="http://www.cocoabuilder.com/archive/message/cocoa/2008/6/30/211682" title="Why aren't my bindings firing?">mentioned before</a> at least once. The solution
is hard to find, though.</p>

<!--more-->

<h2>The Solution</h2>

<p>The first thing you need to know is that <code>-[NSObject
bind:toObject:withKeyPath:options:]</code> will actually use the undocumented
<code>NSAutounbinder</code> mechanism to avoid the retain cycle problem. That is half the
problem solved right there. So the first step is:</p>

<p style="text-align: center;"><strong>DO NOT override <code>bind:toObject:withKeyPath:options:</code> or <code>unbind:</code></strong></p>

<p>Because we’re using the default <code>NSObject</code> implementation, when a bound
property changes in the view, we have to manually set the new value on the
bound object. This is made possible by the fact that all information about the
binding can be obtained from <code>-[NSObject infoForBinding:]</code>. So the second step
is:</p>

<p style="text-align: center;"><strong>Use <code>infoForBinding:</code> to propagate view-driven changes</strong></p>

<p>Below is what I use to handle propagation of view-driven changes. It’s a
category on <code>NSObject</code>, and is used like so:</p>

<div class="language-objc highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">-</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">mouseDown</span><span class="p">:(</span><span class="n">NSEvent</span><span class="o">*</span><span class="p">)</span><span class="nv">theEvent</span><span class="p">;</span>
<span class="p">{</span>
    <span class="n">NSColor</span><span class="o">*</span> <span class="n">newColor</span> <span class="o">=</span> <span class="c1">//mouse down changes the color somehow (view-driven change)</span>
    <span class="n">self</span><span class="p">.</span><span class="n">color</span> <span class="o">=</span> <span class="n">newColor</span><span class="p">;</span>
    <span class="p">[</span><span class="n">self</span> <span class="nf">propagateValue</span><span class="p">:</span><span class="n">newColor</span> <span class="nf">forBinding</span><span class="p">:</span><span class="s">@"color"</span><span class="p">];</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Here is the implementation of <code>propagateValue:forBinding:</code>. It handles value
transformers in the binding options.</p>

<div class="language-objc highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">@implementation</span> <span class="nc">NSObject</span><span class="p">(</span><span class="nl">TDBindings</span><span class="p">)</span>

<span class="k">-</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="nf">propagateValue</span><span class="p">:(</span><span class="n">id</span><span class="p">)</span><span class="nv">value</span> <span class="nf">forBinding</span><span class="p">:(</span><span class="n">NSString</span><span class="o">*</span><span class="p">)</span><span class="nv">binding</span><span class="p">;</span>
<span class="p">{</span>
    <span class="n">NSParameterAssert</span><span class="p">(</span><span class="n">binding</span> <span class="o">!=</span> <span class="nb">nil</span><span class="p">);</span>

    <span class="c1">//WARNING: bindingInfo contains NSNull, so it must be accounted for</span>
    <span class="n">NSDictionary</span><span class="o">*</span> <span class="n">bindingInfo</span> <span class="o">=</span> <span class="p">[</span><span class="n">self</span> <span class="nf">infoForBinding</span><span class="p">:</span><span class="n">binding</span><span class="p">];</span>
    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">bindingInfo</span><span class="p">)</span>
        <span class="k">return</span><span class="p">;</span> <span class="c1">//there is no binding</span>

    <span class="c1">//apply the value transformer, if one has been set</span>
    <span class="n">NSDictionary</span><span class="o">*</span> <span class="n">bindingOptions</span> <span class="o">=</span> <span class="p">[</span><span class="n">bindingInfo</span> <span class="nf">objectForKey</span><span class="p">:</span><span class="n">NSOptionsKey</span><span class="p">];</span>
    <span class="k">if</span><span class="p">(</span><span class="n">bindingOptions</span><span class="p">){</span>
        <span class="n">NSValueTransformer</span><span class="o">*</span> <span class="n">transformer</span> <span class="o">=</span> <span class="p">[</span><span class="n">bindingOptions</span> <span class="nf">valueForKey</span><span class="p">:</span><span class="n">NSValueTransformerBindingOption</span><span class="p">];</span>
        <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">transformer</span> <span class="o">||</span> <span class="p">(</span><span class="n">id</span><span class="p">)</span><span class="n">transformer</span> <span class="o">==</span> <span class="p">[</span><span class="n">NSNull</span> <span class="nf">null</span><span class="p">]){</span>
            <span class="n">NSString</span><span class="o">*</span> <span class="n">transformerName</span> <span class="o">=</span> <span class="p">[</span><span class="n">bindingOptions</span> <span class="nf">valueForKey</span><span class="p">:</span><span class="n">NSValueTransformerNameBindingOption</span><span class="p">];</span>
            <span class="k">if</span><span class="p">(</span><span class="n">transformerName</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">id</span><span class="p">)</span><span class="n">transformerName</span> <span class="o">!=</span> <span class="p">[</span><span class="n">NSNull</span> <span class="nf">null</span><span class="p">]){</span>
                <span class="n">transformer</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSValueTransformer</span> <span class="nf">valueTransformerForName</span><span class="p">:</span><span class="n">transformerName</span><span class="p">];</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">if</span><span class="p">(</span><span class="n">transformer</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">id</span><span class="p">)</span><span class="n">transformer</span> <span class="o">!=</span> <span class="p">[</span><span class="n">NSNull</span> <span class="nf">null</span><span class="p">]){</span>
            <span class="k">if</span><span class="p">([[</span><span class="n">transformer</span> <span class="nf">class</span><span class="p">]</span> <span class="nf">allowsReverseTransformation</span><span class="p">]){</span>
                <span class="n">value</span> <span class="o">=</span> <span class="p">[</span><span class="n">transformer</span> <span class="nf">reverseTransformedValue</span><span class="p">:</span><span class="n">value</span><span class="p">];</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="n">NSLog</span><span class="p">(</span><span class="s">@"WARNING: binding </span><span class="se">\"</span><span class="s">%@</span><span class="se">\"</span><span class="s"> has value transformer, but it doesn't allow reverse transformations in %s"</span><span class="p">,</span> <span class="n">binding</span><span class="p">,</span> <span class="n">__PRETTY_FUNCTION__</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="n">id</span> <span class="n">boundObject</span> <span class="o">=</span> <span class="p">[</span><span class="n">bindingInfo</span> <span class="nf">objectForKey</span><span class="p">:</span><span class="n">NSObservedObjectKey</span><span class="p">];</span>
    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">boundObject</span> <span class="o">||</span> <span class="n">boundObject</span> <span class="o">==</span> <span class="p">[</span><span class="n">NSNull</span> <span class="nf">null</span><span class="p">]){</span>
        <span class="n">NSLog</span><span class="p">(</span><span class="s">@"ERROR: NSObservedObjectKey was nil for binding </span><span class="se">\"</span><span class="s">%@</span><span class="se">\"</span><span class="s"> in %s"</span><span class="p">,</span> <span class="n">binding</span><span class="p">,</span> <span class="n">__PRETTY_FUNCTION__</span><span class="p">);</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">NSString</span><span class="o">*</span> <span class="n">boundKeyPath</span> <span class="o">=</span> <span class="p">[</span><span class="n">bindingInfo</span> <span class="nf">objectForKey</span><span class="p">:</span><span class="n">NSObservedKeyPathKey</span><span class="p">];</span>
    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">boundKeyPath</span> <span class="o">||</span> <span class="p">(</span><span class="n">id</span><span class="p">)</span><span class="n">boundKeyPath</span> <span class="o">==</span> <span class="p">[</span><span class="n">NSNull</span> <span class="nf">null</span><span class="p">]){</span>
        <span class="n">NSLog</span><span class="p">(</span><span class="s">@"ERROR: NSObservedKeyPathKey was nil for binding </span><span class="se">\"</span><span class="s">%@</span><span class="se">\"</span><span class="s"> in %s"</span><span class="p">,</span> <span class="n">binding</span><span class="p">,</span> <span class="n">__PRETTY_FUNCTION__</span><span class="p">);</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="p">[</span><span class="n">boundObject</span> <span class="nf">setValue</span><span class="p">:</span><span class="n">value</span> <span class="nf">forKeyPath</span><span class="p">:</span><span class="n">boundKeyPath</span><span class="p">];</span>
<span class="p">}</span>

<span class="k">@end</span>
</code></pre></div></div>

<p>I hope this helps! I’d like to thank <a href="http://stackoverflow.com/users/143388/ryan-ballantyne">Ryan Ballantyne</a> and Louis Gerbarg
for their input, and <a href="http://boredzo.org/">Peter Hosey</a> for further investigation into the
problem.</p>

</div>

  <footer>
    <div class="tw-rounded-3xl tw-bg-pink-100 tw-p-8 tw-my-16 tw-text-center tw-bg-opacity-50">
      <p class="tw-text-2xl tw-uppercase tw-text-pink-900 tw-font-black tw-mb-4">Enjoy this?</p>

      <p class="tw-flex tw-flex-col sm:tw-flex-row tw-justify-center tw-item-center sm:tw-items-baseline">
        <a href="/feed/" class="tw-flex-1 tw-bg-pink-500 tw-py-3 tw-px-4 tw-rounded-lg tw-text-pink-100 tw-ring-2 tw-ring-pink-300 hover:tw-text-white">Subscribe via RSS</a>
        <span class="tw-flex-none tw-px-8 tw-py-4 tw-text-pink-800">or</span>
        <a href="https://twitter.com/tom_dalling" class="tw-flex-1 tw-bg-pink-500 tw-py-3 tw-px-4 tw-rounded-lg tw-text-pink-100 tw-ring-2 tw-ring-pink-300 hover:tw-text-white">Follow on Twitter</a>
      </p>

      <p class="tw-text-center tw-mt-4 tw-mb-0 tw-text-pink-900">
        <em>Found a mistake?</em> Pull requests are welcome on
        <a href="https://github.com/tomdalling/tomdalling.com/whatever">GitHub</a>.
      </p>
</div>

    


    
      <h2>Comments</h2>
      <div id="disqus_thread"></div>
      <script type="text/javascript" id="disqus_script">
        var disqus_shortname = "tomdalling";
        var disqus_identifier = "119 http://tomdalling.com/?p=119";
        var disqus_title = "Implementing Your Own Cocoa Bindings";
        var disqus_url = "https://www.tomdalling.com/blog/cocoa/implementing-your-own-cocoa-bindings/";

        (function() {
          var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
          dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
          (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
      </script>
      <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments.</a>
</noscript>
    

  </footer>
</article>
</main>

      <aside class="tw-px-4 tw-text-center lg:tw-text-left lg:tw-w-1/3 tw-flex-none">

        <div class="tw-text-lg tw-font-title tw-mb-1">Subscribe</div>
        <ul class="tw-space-y-2">
          <li>
            <a href="/blog/feed/">
              <i class="fa fa-rss"></i> RSS
            </a>
          </li>
          <li>
            <a href="https://twitter.com/tom_dalling">
              <i class="fa fa-twitter"></i> Twitter
            </a>
          </li>
        </ul>

        <div class="tw-text-lg tw-font-title tw-mb-1 tw-mt-6">Recent Posts</div>
        <ul class="recent-posts tw-space-y-2">
          
        <li><a href="/blog/software-processes/ditch-the-umbrella-and-grab-some-sunnies/">Ditch The Umbrella And Grab Some Sunnies</a></li>
<li><a href="/blog/software-processes/nugs-and-negative-failure-demand/">Nugs And Negative Failure Demand</a></li>
<li><a href="/blog/software-processes/against-must-haves-part-two/">Against Must-Haves (Part Two)</a></li>
<li><a href="/blog/software-processes/against-must-haves-part-one/">Against Must-Haves (Part One)</a></li>
<li><a href="/blog/software-processes/agile-is-a-glass-cannon/">Agile Is A Glass Cannon</a></li>
</ul>

        <div class="tw-text-lg tw-font-title tw-mb-1 tw-mt-6">Categories</div>
        <ul class="categories tw-space-y-2">
          
        <li>
            <a href="/blog/cocoa/" class="category">Cocoa</a>
            (<span class="post-count">5</span>
            <a class="feed" href="/blog/cocoa/feed/"><i class="fa fa-rss"></i></a>)
          </li>
<li>
            <a href="/blog/coding-styleconventions/" class="category">Coding Style/Conventions</a>
            (<span class="post-count">3</span>
            <a class="feed" href="/blog/coding-styleconventions/feed/"><i class="fa fa-rss"></i></a>)
          </li>
<li>
            <a href="/blog/coding-tips/" class="category">Coding Tips</a>
            (<span class="post-count">4</span>
            <a class="feed" href="/blog/coding-tips/feed/"><i class="fa fa-rss"></i></a>)
          </li>
<li>
            <a href="/blog/mentoring/" class="category">Mentoring Notes</a>
            (<span class="post-count">3</span>
            <a class="feed" href="/blog/mentoring/feed/"><i class="fa fa-rss"></i></a>)
          </li>
<li>
            <a href="/blog/random-stuff/" class="category">Miscellaneous</a>
            (<span class="post-count">4</span>
            <a class="feed" href="/blog/random-stuff/feed/"><i class="fa fa-rss"></i></a>)
          </li>
<li>
            <a href="/blog/modern-opengl/" class="category">Modern OpenGL Series</a>
            (<span class="post-count">10</span>
            <a class="feed" href="/blog/modern-opengl/feed/"><i class="fa fa-rss"></i></a>)
          </li>
<li>
            <a href="/blog/ruby/" class="category">Ruby</a>
            (<span class="post-count">2</span>
            <a class="feed" href="/blog/ruby/feed/"><i class="fa fa-rss"></i></a>)
          </li>
<li>
            <a href="/blog/software-design/" class="category">Software Design</a>
            (<span class="post-count">12</span>
            <a class="feed" href="/blog/software-design/feed/"><i class="fa fa-rss"></i></a>)
          </li>
<li>
            <a href="/blog/software-processes/" class="category">Software Processes</a>
            (<span class="post-count">8</span>
            <a class="feed" href="/blog/software-processes/feed/"><i class="fa fa-rss"></i></a>)
          </li>
<li>
            <a href="/blog/testing/" class="category">Testing</a>
            (<span class="post-count">2</span>
            <a class="feed" href="/blog/testing/feed/"><i class="fa fa-rss"></i></a>)
          </li>
<li>
            <a href="/blog/web/" class="category">Web</a>
            (<span class="post-count">1</span>
            <a class="feed" href="/blog/web/feed/"><i class="fa fa-rss"></i></a>)
          </li>
</ul>

        <div class="tw-text-lg tw-font-title tw-mb-1 tw-mt-6">Archives</div>
        <ul class="archives tw-space-y-2">
          
        <li>
            <a href="/blog/2024/" class="year">2024</a>
            (<span class="post-count">1</span>)
          </li>
<li>
            <a href="/blog/2023/" class="year">2023</a>
            (<span class="post-count">5</span>)
          </li>
<li>
            <a href="/blog/2022/" class="year">2022</a>
            (<span class="post-count">1</span>)
          </li>
<li>
            <a href="/blog/2021/" class="year">2021</a>
            (<span class="post-count">6</span>)
          </li>
<li>
            <a href="/blog/2020/" class="year">2020</a>
            (<span class="post-count">5</span>)
          </li>
<li>
            <a href="/blog/2016/" class="year">2016</a>
            (<span class="post-count">1</span>)
          </li>
<li>
            <a href="/blog/2015/" class="year">2015</a>
            (<span class="post-count">2</span>)
          </li>
<li>
            <a href="/blog/2014/" class="year">2014</a>
            (<span class="post-count">3</span>)
          </li>
<li>
            <a href="/blog/2013/" class="year">2013</a>
            (<span class="post-count">5</span>)
          </li>
<li>
            <a href="/blog/2012/" class="year">2012</a>
            (<span class="post-count">10</span>)
          </li>
<li>
            <a href="/blog/2011/" class="year">2011</a>
            (<span class="post-count">1</span>)
          </li>
<li>
            <a href="/blog/2010/" class="year">2010</a>
            (<span class="post-count">5</span>)
          </li>
<li>
            <a href="/blog/2009/" class="year">2009</a>
            (<span class="post-count">9</span>)
          </li>
</ul>

      </aside>

    </div>

    <footer class="page-footer">
      <p>© 2009 – <span class="current-year">2024</span> Tom Dalling</p>

      <p class="social">
        <a href="https://twitter.com/tom_dalling">
          <i class="fa fa-lg fa-twitter"></i>
        </a>
        <a href="https://github.com/tomdalling">
          <i class="fa fa-lg fa-github"></i>
        </a>
        <a href="https://stackoverflow.com/users/108105/tom-dalling">
          <i class="fa fa-lg fa-stack-overflow"></i>
        </a>
        <a href="mailto:tom%20at%20tomdalling%20com">
          <i class="fa fa-lg fa-envelope"></i>
        </a>
      </p>
    </footer>

    <script src="/bundles/all.js"></script>
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        tex2jax: {
          inlineMath: [['$$','$$']],
          displayMath: [['[blockmath]', '[/blockmath]']]
        }
      });
    </script>
    <script type="text/javascript" async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>

  </body>
</html>
